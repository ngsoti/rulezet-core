{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container py-5" id="main-container">
    <template v-if="is_loading">
        <div class="row mb-5 align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold text-dark mb-2">
                    Security Intelligence <span class="text-primary">Repository</span>
                </h1>
                <p class="lead text-muted">
                    Explore the latest community-contributed detection rules. Stay ahead of threats with real-time
                    updates.
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="d-inline-flex p-2 rounded-3 border">
                    <div class="px-3 border-end">
                        <span class="d-block fw-bold text-primary">[[ rules_list.length ]]</span>
                        <small class="text-uppercase text-muted" style="font-size: 0.7rem;">New Rules</small>
                    </div>
                    <div class="px-3">
                        <span class="d-block fw-bold text-success">Live</span>
                        <small class="text-uppercase text-muted" style="font-size: 0.7rem;">Status</small>
                    </div>
                </div>
            </div>
        </div>


        <div class="row g-4">
            <template v-if="rules_list.length > 0">
                <div class="col-xl-4 col-md-6" v-for="(rule, index) in rules_list" :key="rule.uuid">
                    <div class="card h-100 shadow-sm transition-hover border-0 card-security-premium"
                        style="cursor: pointer; position: relative; overflow: hidden; border-radius: 12px;">

                        <div class=" premium-accent-line"></div>

                        <div class="card-watermark">
                            <i class="fa-solid fa-shield-halved"></i>
                        </div>

                        <div class="position-absolute top-0 end-0 mt-3 me-3 shadow-sm z-index-2">
                            <span class="badge rounded-pill bg-dark pt-1">[[ rule.format.toUpperCase() ]]</span>
                        </div>

                        <div class="card-body d-flex flex-column p-4 z-index-1">
                            <div class="mb-3 pe-5">
                                <h5 class="fw-bold mb-1">
                                    <a :href="`/rule/detail_rule/${rule.id}`"
                                        class="fw-bold h5 mb-4 border-start border-primary border-4 ps-3 custom-rule-link"
                                        title="See more about this rule">
                                        [[ rule.title ]]
                                    </a>
                                </h5>
                                <div class="d-flex align-items-center gap-2 mt-2">
                                    <div class="avatar-circle-xs" title="Author of the rule">
                                        <template v-if="rule.author === 'Unknown'">
                                            [[ rule.editor[0].toUpperCase() ]]
                                        </template>
                                        <template v-else>
                                            [[ rule.author[0].toUpperCase() ]]
                                        </template>
                                    </div>
                                    <small class="text-muted fw-medium" title="Author of the rule"> <template
                                            v-if="rule.author === 'Unknown'">
                                            [[ rule.editor ]]
                                        </template>
                                        <template v-else>
                                            [[ rule.author ]]
                                        </template>
                                    </small>
                                    <span class="text-muted opacity-50">|</span>
                                    <small class="text-muted" title="Last modification of the rule">[[
                                        dayjs.utc(rule.last_modif).fromNow() ]]</small>
                                </div>
                            </div>

                            <div class="flex-grow-1">
                                <p class="text-muted small lh-base" title="Description of the rule">
                                    <template v-if="!rule.show_full">
                                        [[ rule.description.substring(0, 140) ]]
                                        <span v-if="rule.description.length > 140">...</span>
                                        <a v-if="rule.description.length > 140" href="#"
                                            @click.prevent="rule.show_full = true"
                                            class="text-primary text-decoration-none fw-semibold ms-1">Read more</a>
                                    </template>
                                    <template v-else>
                                        [[ rule.description ]]
                                        <a href="#" @click.prevent="rule.show_full = false"
                                            class="text-primary text-decoration-none fw-semibold ms-1">Show less</a>
                                    </template>
                                </p>
                            </div>

                            <div class="mt-3 mb-4 min-h-40">
                                <div v-if="rule.cve_id && rule.cve_id !== 'None'" class="d-flex flex-wrap gap-1">
                                    <a v-for="cve in parsedCVE(rule.cve_id)"
                                        :href="'https://vulnerability.circl.lu/vuln/' + cve.toLowerCase()"
                                        target="_blank" :class="['badge', 'text-decoration-none', getCVEColor(cve)]"
                                        style="font-size: 0.75rem; font-weight: 500; border-radius: 6px;"
                                        title="See more about this cve">
                                        [[ cve ]]
                                    </a>
                                </div>
                            </div>

                            <div
                                class="d-flex justify-content-between align-items-center pt-3 border-top mt-auto bg-transparent">
                                <div class="btn-group shadow-sm border rounded-pill overflow-hidden">
                                    <button @click="vote('up', rule.id); animateClick($event)"
                                        class="btn btn-sm px-3 border-0 border-end border-light shadow-none btn-animate home-btn"
                                        title="Like this rule">
                                        <i class="fas fa-thumbs-up text-primary me-1"></i> [[ rule.vote_up ]]
                                    </button>

                                    <button @click="vote('down', rule.id); animateClick($event)"
                                        class="btn btn-sm px-3 border-0 shadow-none btn-animate home-btn"
                                        title="Dislike this rule">
                                        <i class="fas fa-thumbs-down text-danger me-1"></i> [[ rule.vote_down ]]
                                    </button>
                                </div>

                                <div class="d-flex gap-2">
                                    <button
                                        @click="favorite(rule.id); $event.currentTarget.classList.add('star-animate')"
                                        @animationend="$event.currentTarget.classList.remove('star-animate')"
                                        :title="rule.is_favorited ? 'Unfavorite this rule' : 'Favorite this rule'"
                                        class="btn btn-sm rounded-circle shadow-sm p-0 d-flex align-items-center justify-content-center transition-all home-btn"
                                        style="width: 32px; height: 32px;">
                                        <i class="fa-star" :class="rule.is_favorited ? 'fas text-warning' : 'far'"></i>
                                    </button>

                                    <div class="dropdown">
                                        <button
                                            class="btn btn-sm rounded-circle shadow-sm p-0 d-flex align-items-center justify-content-center home-btn"
                                            style="width: 32px; height: 32px;" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-h"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                            <li
                                                v-if="parseInt('{{ current_user.id }}') === rule.user_id || current_user_is_admin">
                                                <a class="dropdown-item" :href="`rule/edit_rule/${rule.id}`">
                                                    <i class="fas fa-edit me-2 text-muted"></i> Edit Rule
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" :href="`/rule/report/${rule.id}`">
                                                    <i class="fas fa-flag me-2 text-muted"></i> Report issue
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- see more button to redirect to rule list-->
                <div class="text-center mt-5 mb-4">
                    <a href="/rule/rules_list" class="btn btn-more-rules px-4 py-2 rounded-pill fw-bold">
                        <span>See more rules</span>
                        <i class="fa-solid fa-arrow-right ms-2 transition-arrow"></i>
                    </a>
                </div>
            </template>

            <template v-else>
                <div class="col-12 text-center py-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" alt="No rules"
                        style="width: 80px; opacity: 0.3;">
                    <p class="text-muted mt-3">No recent rules found. Check back later!</p>
                </div>
            </template>
        </div>
    </template>
    <template v-else>
        <!-- spin to load-->
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </template>
</div>
{% endblock %}

{% block script %}
<script type="module">
    const { createApp, ref, onMounted } = Vue
    import { display_toast, message_list, create_message } from '/static/js/toaster.js'

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const is_loading = ref(false)
            const rules_list = ref([])
            const current_user_is_admin = ref(false)
            const current_user_is_connected = ref(false)

            async function fetchRecentRules() {
                const res = await fetch('/get_last_rules')
                if (res.status == 200) {
                    const data = await res.json()
                    // Initialize show_full property for each rule
                    rules_list.value = (data.rules || []).map(r => ({ ...r, show_full: false }))
                }

            }

            async function checkIfUserIsConnected() {
                const res = await fetch('/get_current_user_connected');
                const data = await res.json();
                current_user_is_connected.value = data.is_authenticated;
                if (data.is_authenticated) {
                    const userRes = await fetch('/rule/get_current_user')
                    const userData = await userRes.json()
                    current_user_is_admin.value = userData.user // Assuming 'user' boolean field
                }
            }

            async function favorite(rule_id) {
                if (!current_user_is_connected.value) {
                    window.location.href = `/account/login`;
                    return;
                }
                const res = await fetch(`/rule/favorite/${rule_id}`);
                const data = await res.json();
                if (res.ok) {
                    const rule = rules_list.value.find(r => r.id === rule_id);
                    if (rule) rule.is_favorited = data.is_favorited;
                }
                create_message(data.message, data.toast_class);
            }

            async function vote(voteType, ruleId) {
                if (!current_user_is_connected.value) {
                    window.location.href = `/account/login`;
                    return;
                }
                const res = await fetch(`/rule/vote_rule?id=${ruleId}&vote_type=${voteType}`);
                const data = await res.json();
                const updated = rules_list.value.find(rule => rule.id === ruleId);
                if (updated) {
                    updated.vote_up = data.vote_up;
                    updated.vote_down = data.vote_down;
                }
            }

            function animateClick(event) {
                const btn = event.currentTarget;
                btn.classList.add('click-pop');

                // On retire la classe aprÃ¨s l'animation (300ms) pour pouvoir la rejouer
                setTimeout(() => {
                    btn.classList.remove('click-pop');
                }, 300);
            }

            function parsedCVE(cveField) {
                if (!cveField) return [];
                try {
                    const parsed = typeof cveField === 'string' ? JSON.parse(cveField) : cveField;
                    return Array.isArray(parsed) ? parsed : [parsed];
                } catch (e) {
                    return cveField.replace(/[{}]/g, "").split(",").map(s => s.trim()).filter(s => s !== "");
                }
            }

            function getCVEColor(cve) {
                const c = cve.toUpperCase();
                if (c.startsWith("CVE")) return "bg-danger";
                if (c.startsWith("GHSA")) return "bg-warning text-dark";
                if (c.startsWith("PYSEC")) return "bg-info text-dark";
                if (c.startsWith("RHSA") || c.startsWith("MS")) return "bg-purple";
                return "bg-secondary";
            }

            async function init() {
                is_loading.value = false

                await Promise.all([
                    fetchRecentRules(),
                    checkIfUserIsConnected()
                ])
                is_loading.value = true

            }

            onMounted(() => {
                init()
            })



            return {
                message_list,
                rules_list,
                current_user_is_admin,
                dayjs,
                vote,
                favorite,
                parsedCVE,
                getCVEColor,
                animateClick,
                is_loading,
            }
        }
    }).mount('#main-container')
</script>
{% endblock %}