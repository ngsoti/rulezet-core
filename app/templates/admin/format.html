
{% extends 'base.html' %}

{% block content %}
{% if current_user.is_admin() %}
<div class="container my-4" id="main-container">

    <div class="mb-4 border-bottom pb-3">
        <h2 class="mb-3 text-center text-primary fw-bold">
            Manage Rule Format
            <div class="mx-auto" style="width: 60px; height: 4px; background-color: #0d6efd; border-radius: 2px;"></div>
        </h2>
        <p class="text-muted mt-2">
            Here you can create, modify, and delete rule formats used in the system. Rule formats define how rules are structured and executed. Please proceed with caution when making changes, as they may affect existing rules.
        </p>
    </div>

    <ul class="nav nav-underline justify-content-center w-100 mb-3" id="exampleTabs" role="tablist">
        <li class="nav-item flex-fill text-center">
            <a class="nav-link active" id="chap1-tab" data-bs-toggle="tab" href="#chap1-pane" role="tab" aria-controls="chap1-pane" aria-selected="true" style="color: var(--text-color);">
                    Create a Format
            </a>
        </li>
        <li class="nav-item flex-fill text-center">
            <a class="nav-link" id="chap2-tab" data-bs-toggle="tab" href="#chap2-pane" role="tab" aria-controls="chap2-pane" aria-selected="false" style="color: var(--text-color);">
                    Change a Format
            </a>
        </li>
        <li class="nav-item flex-fill text-center">
            <a class="nav-link" id="chap3-tab" data-bs-toggle="tab" href="#chap3-pane" role="tab" aria-controls="chap3-pane" aria-selected="false" style="color: var(--text-color);">
                    List Formats
            </a>
        </li>
    </ul>

    <!-- Tab panes for format management -->
    <div class="tab-content" id="exampleTabsContent">
        <!-- Create Format Tab -->
        <div class="tab-pane fade show active" id="chap1-pane" role="tabpanel" aria-labelledby="chap1-tab">
            <div class="card card-body shadow-sm" id="main-container">
                <form method="POST" action="{{ url_for('rule.manage_format_rule') }}">
                    {{ form.hidden_tag() }}

                    <div class="mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control", placeholder="Enter format name") }}
                        {% for error in form.name.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <div class="form-check mb-3">
                        {{ form.can_be_execute(class="form-check-input") }}
                        {{ form.can_be_execute.label(class="form-check-label") }}
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-1"></i> Create Format
                    </button>
                </form>
            </div>
        </div>
        <!-- Change Format Tab -->
        <div class="tab-pane fade" id="chap2-pane" role="tabpanel" aria-labelledby="chap2-tab">
            <div class="card card-body shadow-sm" id="main-container">
                <form method="POST" action="{{ url_for('rule.replace_format_rule') }}">
                    {{ form.hidden_tag() }}

                    <div class="mb-3">
                        <label for="current_format" class="form-label"><strong>Current Format Name</strong></label>
                        <input type="text" class="form-control" id="current_format" name="current_format" placeholder="Enter format to replace" required>
                        <div class="form-text">Ex: Sigma</div>
                    </div>

                    <div class="mb-3">
                        <label for="new_format" class="form-label"><strong>New Format Name</strong></label>
                        <input type="text" class="form-control" id="new_format" name="new_format" placeholder="Enter replacement format" required>
                        <div class="form-text">Ex: sigma</div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-1"></i> Replace Format
                    </button>
                </form>
            </div>
        </div>

        <!-- List Formats Tab -->
        <div class="tab-pane fade" id="chap3-pane" role="tabpanel" aria-labelledby="chap3-tab">
            <div class="card card-body shadow-sm" id="main-container">
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Executable</th>
                            <th>Creation Date</th>
                            <th>Count of rules</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="format in rules_formats" :key="format.id">
                            <td>[[ format.id ]]</td>
                            <td>[[ format.name ]]</td>
                            <td>
                                <span class="badge bg-success" v-if="format.can_be_execute">Yes</span>
                                <span class="badge bg-secondary" v-else>No</span>
                            </td>
                            <td>[[ format.creation_date ]]</td>
                            <td> [[ format.number_of_rule_with_this_format ]]</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm me-2" title="Delete the format" data-bs-toggle="modal" :data-bs-target="'#delete_format_modal_'+format.id">
                                    <i class="fa-solid fa-trash fa-fw"></i>
                                </button>
                                <div class="modal fade" :id="'delete_format_modal_'+format.id" tabindex="-1" aria-labelledby="delete_format_modal" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">

                                            <div class="modal-header">
                                                <h1 class="modal-title fs-5" :id="'delete_format_modal_label_'+format.id">
                                                    Delete format "<strong>[[ format.name ]]</strong>" ?
                                                </h1>
                                                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>

                                            <div class="modal-body">
                                                <p>
                                                    <i class="fa-solid fa-triangle-exclamation text-warning me-2"></i>
                                                    This format is used by <strong>[[ format.number_of_rule_with_this_format ]]</strong> rule<span v-if="format.number_of_rule_with_this_format > 1">s</span>.
                                                </p>
                                                <p class="text-danger fw-bold mb-0">
                                                    Deleting this format will permanently remove the association from all related rules. These rules will no longer have any format assigned.
                                                </p>
                                            </div>

                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="button" class="btn btn-danger" @click="deleteFormat(format.id)" data-bs-dismiss="modal">
                                                    <i class="fa-solid fa-trash"></i> Confirm Deletion
                                                </button>
                                            </div>

                                        </div>
                                    </div>
                                </div>

                            </td>
                        </tr>
                        <tr v-if="rules_formats.length === 0">
                            <td colspan="5" class="text-center text-muted">No formats found.</td>
                        </tr>
                    </tbody>
                </table>
                <div v-if="total_rules_formats_page > 1">
                    {% set current_page = 'current_page' %}
                    {% set total_pages = 'total_rules_formats_page' %}
                    {% set visible_pages = 'visiblePages' %}
                    {% set fetch_function = 'fetchRulesFormat' %}

                    {% include "components/pagination.html" %}
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<script>
    window.location.href = "{{ url_for('account.acces_denied') }}";
</script>
{% endif %}
{% endblock %}

{% block script %}
<script type="module">
const { createApp, ref, computed } = Vue;
import { display_toast, prepare_toast, message_list } from '/static/js/toaster.js';

createApp({
    delimiters: ['[[', ']]'],
    setup() {
        /**
         *          ####################
         *          #   fetch formats  #
         *          ####################
         * */

        const rules_formats = ref([])
        const current_page = ref(1)
        const total_rules_formats_page = ref(0)

        async function fetchRulesFormat(page) {
            const params = new URLSearchParams({ page });
            const res = await fetch('/rule/get_rules_formats_pages?' + params.toString());
            const data = await res.json();
            if (res.status === 200) {
                rules_formats.value = data.rules_formats;
                total_rules_formats_page.value = data.total_rules_formats;
                current_page.value = page;
            }
        }

        async function deleteFormat(id) {
            const params = new URLSearchParams({ id });
            const res = await fetch('/rule/delete_format_rule?' + params.toString());
            if (res.status === 200 ) {
                fetchRulesFormat(current_page.value);
                var myModalEl = document.getElementById('delete_format_modal_'+id);
                var modal = bootstrap.Modal.getInstance(myModalEl)
                modal.hide();
            } 
            display_toast(res)

        }

        // Initial fetch
        fetchRulesFormat(1)

         const visiblePages = computed(() => {
                const pages = []
                const total = total_rules_formats_page.value
                const current = current_page.value
                if (total <= 7) {
                    for (let i = 1; i <= total; i++) pages.push(i)
                } else {
                    if (current <= 4) {
                        pages.push(1, 2, 3, 4, 5, '...', total)
                    } else if (current >= total - 3) {
                        pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
                    } else {
                        pages.push(1, '...', current - 1, current, current + 1, '...', total)
                    }
                }
                return pages
            })

        return {
            message_list,
            rules_formats,
            current_page,
            total_rules_formats_page,
            fetchRulesFormat,
            deleteFormat,
            visiblePages
        };

    }
}).mount('#main-container');
</script>
{% endblock %}