{% extends 'base.html' %}
{% block content %}
<div class="container my-5" id="main-container">

  <div id="bundle-info" data-bundle-id="{{ bundle_id }}"></div>
  <div class="mb-4 border-bottom pb-3">
    <h2 class="fw-bold text-primary text-center">
      Bundle Details
      <div class="mx-auto" style="width: 60px; height: 4px; background-color: #0d6efd; border-radius: 2px;"></div>
    </h2>
    <p class="text-muted mt-2">
      Here you can find all the information about this specific bundle, including its description, rules, and author.
    </p>
  </div>
  <template v-if="bundle">

    <!-- Carte principale du bundle -->
    <div class="card bg-white shadow-sm border-0 mb-4">
      <div class="card-body">

        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-start mb-3 gap-3 flex-wrap">

          <!-- LEFT : TITLE + ACCESS -->
          <div class="d-flex align-items-center flex-wrap gap-2">

            <!-- TITLE -->
            <div class="d-flex align-items-center gap-2 bundle-title-wrapper">
              <i class="fas fa-box-open text-secondary bundle-icon"></i>

              <h2 class="bundle-title fw-bold mb-0 text-primary" :title="bundle.name">
                [[ bundle.name ]]
              </h2>

              <!-- VIEW FULL TITLE -->
              <button class="btn btn-link btn-sm p-0 text-muted" data-bs-toggle="modal"
                :data-bs-target="'#bundleTitleModal_'+bundle.id" title="View full name">
                <i class="fas fa-eye"></i>
              </button>
            </div>

            <!-- ACCESS -->
            <template v-if="parseInt('{{ current_user.id }}') === bundle.user_id || is_admin">
              <button class="btn btn-outline-secondary btn-sm"
                :class="bundle.access ? 'btn-outline-success' : 'btn-outline-danger'" @click="edit_access(bundle.id)"
                :title="bundle.access ? 'Make Private' : 'Make Public'">
                <i :class="bundle.access ? 'fas fa-lock-open' : 'fas fa-lock'"></i>
                <span class="ms-1">[[ bundle.access ? 'Public' : 'Private' ]]</span>
              </button>
            </template>

            <template v-else>
              <span class="badge" :class="bundle.access ? 'bg-success' : 'bg-danger'">
                <i :class="bundle.access ? 'fas fa-lock-open' : 'fas fa-lock'"></i>
                <span class="ms-1">[[ bundle.access ? 'Public' : 'Private' ]]</span>
              </span>
            </template>

          </div>

          <!-- RIGHT : ACTIONS -->
          <div class="d-flex align-items-center gap-2">

            <button class="btn btn-success btn-sm" title="Download all rules as ZIP" @click="DownloadBundle">
              <i class="fas fa-download"></i>
            </button>

            {% if current_user.is_authenticated %}
            <template v-if="parseInt('{{ current_user.id }}') === bundle.user_id || is_admin">

              <a :href="`/bundle/edit/${bundle_id}`" class="btn btn-secondary btn-sm" title="Edit Bundle">
                <i class="fas fa-pen"></i>
              </a>

              <button class="btn btn-danger btn-sm" title="Delete bundle" data-bs-toggle="modal"
                :data-bs-target="'#delete_bundle_modal_'+bundle.id">
                <i class="fa-solid fa-trash"></i>
              </button>

            </template>
            {% endif %}
          </div>

        </div>

        <!-- META -->
        <p class="fst-italic text-secondary mb-0">
          Created on [[ bundle.created_at ]] · Updated on [[ bundle.updated_at ]]
        </p>

      </div>
    </div>

    <!-- MODAL : FULL TITLE -->
    <div class="modal fade" :id="'bundleTitleModal_'+bundle.id" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Bundle name</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <strong>[[ bundle.name ]]</strong>
          </div>

        </div>
      </div>
    </div>


    <!-- Carte Description -->
    <div class="card bg-white shadow-sm border-0 mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="text-primary">Description</h4>
          <div class="d-flex align-items-center gap-2">
            <button @click="vote('up', bundle.id)" title="Like this bundle" class="btn btn-success btn-sm">
              <i class="fas fa-thumbs-up"></i> [[ bundle.vote_up ]]
            </button>
            <button @click="vote('down', bundle.id)" title="Dislike this bundle" class="btn btn-danger btn-sm">
              <i class="fas fa-thumbs-down"></i> [[ bundle.vote_down ]]
            </button>
          </div>
        </div>
        <p>[[ bundle.description || 'No description provided.' ]]</p>
      </div>
    </div>

    <!-- Carte Rules -->
    <div class="card bg-white shadow-sm border-0 mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <h4 class="mb-0 text-primary">Rules included in this bundle</h4>
          <span class="badge bg-primary ms-2">
            [[ rules.length ]]
          </span>
        </div>
        <template v-if="rules.length === 0">
          <div class="alert alert-warning text-center shadow-sm mt-3">
            <i class="fas fa-circle-info me-2"></i>
            <span>There is no rule in this bundle for the moment</span>
          </div>
        </template>

        <template v-else>
          <ul class="list-group list-group-flush mt-3">
            <li v-for="(item, index) in rules" :key="item.rule.cve_id" class="list-group-item bundle-card"
              @click="goTo(item.rule.id)" style="cursor: pointer;">

              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <span class="badge bg-secondary me-2">[[ item.rule.format ]]</span>
                  <a :href="`/rule/detail_rule/${item.rule.id}`" title="View more about this rule" @click.stop>
                    <h5 class="d-inline fw-bold text-primary mb-0 me-2">[[ item.rule.title ]]</h3>
                  </a>
                  <a v-for="(cve, index) in parsedCVE(item.rule.cve_id)" :key="index"
                    :href="'https://vulnerability.circl.lu/vuln/' + cve.toLowerCase()" target="_blank"
                    :class="['badge', 'me-1', 'mb-1', getCVEColor(cve)]" data-bs-toggle="tooltip"
                    :title="'Detected vulnerability ID: ' + cve" style="text-decoration: none;" @click.stop>

                    <i :class="getCVEIcon(cve)" class="me-1"></i>
                    [[ getCVEPrefix(cve) ]]
                    <span class="text-light fw-semibold">[[ getCVENumber(cve) ]]</span>
                  </a>


                </div>

                {% if current_user.is_authenticated %}
                <template v-if="parseInt('{{current_user.id}}') == bundle.user_id || is_admin">
                  <div>
                    <button type="button" class="btn btn-sm " style="color: var(--text-color)"
                      title="Edit the description" data-bs-toggle="modal"
                      :data-bs-target="'#description_bundle_modal_'+item.rule.id"
                      @click="item.new_description = item.association.description" @click.stop>
                      <i class="fa-solid fa-pen fa-fw"></i>
                    </button>

                    <div class="modal fade" :id="'description_bundle_modal_'+item.rule.id" tabindex="-1"
                      aria-labelledby="description_bundle_modal" aria-hidden="true" @click.stop>
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h1 class="modal-title fs-5 text-dark">Edit description for [[ item.rule.title ]]</h1>
                            <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <label for="bundleNewDescription" class="form-label fw-bold">New description</label>
                              <textarea id="bundleNewDescription" v-model="item.new_description" class="form-control"
                                @click.stop rows="3" placeholder="Enter the new description here..."></textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                              @click.stop>Close</button>
                            <button class="btn btn-success" @click="saveNewDescription(item.association.id , item)"
                              @click.stop>
                              <i class="fa-solid fa-check"></i> Save
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </template>
                {% endif %}
              </div>

              <div>
                <p class="mb-0" style="white-space: pre-wrap; max-width: 95%;">
                  [[ item.association.description ]]
                </p>
              </div>

            </li>
          </ul>

        </template>
      </div>
    </div>

    <!-- Carte Auteur -->
    <div class="card bg-white shadow-sm border-0 mb-4">
      <div class="card-body">
        <h5 class="text-primary">Author</h5>
        <a :href="`/account/detail_user/${bundle.user_id}`" title="View author's profile">
          [[ bundle.user_name ]]
        </a>
      </div>
    </div>

  </template>

  <div v-else class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading bundle data...</p>
  </div>

</div>
{% endblock %}


{% block script %}
<script type="module">
  const bundle_id = document.getElementById('bundle-info').dataset.bundleId;
  const { createApp, ref } = Vue;
  import { display_toast, message_list, create_message } from '/static/js/toaster.js';

  createApp({
    delimiters: ['[[', ']]'],
    setup() {
      /**
       *          #####################
       *          #   Fetch bundle    #
       *          #####################
       */

      const bundle = ref(null);
      const rules = ref([]);

      async function fetchBundle() {
        const params = new URLSearchParams({ bundle_id });
        try {
          const res = await fetch('/bundle/get_bundle?' + params.toString());
          const data = await res.json();
          if (res.ok && data.success) {
            bundle.value = data.bundle;
            rules.value = data.rules || [];
          } else {
            display_toast('Error loading bundle: ' + (data.message || 'Unknown error'), 'error');
          }
        } catch (e) {
          display_toast('Fetch error: ' + e.message, 'error');
        }
      }
      fetchBundle();

      /**
       *          ######################
       *          #   action bundle    #
       *          ######################
       */

      async function deleteBundle(id, index) {
        const params = new URLSearchParams({
          id
        })
        const res = await fetch('/bundle/delete?' + params.toString())
        if (await res.status == 200) {
          var myModalEl = document.getElementById('delete_bundle_modal_' + id);
          var modal = bootstrap.Modal.getInstance(myModalEl)
          modal.hide();
          window.location.href = `/bundle/list`;
        } else {
          display_toast(res)
        }
      }

      async function edit_access(id) {
        const params = new URLSearchParams({
          id
        })
        const res = await fetch('/bundle/edit_access?' + params.toString())
        if (await res.status == 200) {
          bundle.value.access = !bundle.value.access
        }
        display_toast(res)
      }


      async function saveNewDescription(association_id, item) {
        if (item.new_description !== undefined && item.new_description.trim() !== "") {

          const params = new URLSearchParams({
            new_description: item.new_description,
            association_id
          })
          const res = await fetch('/bundle/change_description?' + params.toString())
          if (await res.status == 200) {
            item.association.description = item.new_description; // or fetch the rule ?
            var myModalEl = document.getElementById('description_bundle_modal_' + item.rule.id);
            var modal = bootstrap.Modal.getInstance(myModalEl)
            modal.hide();
          }
          display_toast(res)
        }
      }

      async function DownloadBundle() {
        const params = new URLSearchParams({ bundle_id });
        const res = await fetch('/bundle/download?' + params.toString());

        if (res.status === 200) {
          const blob = await res.blob();

          // download section
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${bundle.value.name}.zip`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);

          await create_message("Bundle download with success", "success-subtle");

        } else {
          display_toast(res);
        }
      }
      const current_user_is_connected = ref("{{ current_user.is_authenticated }}");
      if (current_user_is_connected.value == "True") {
        current_user_is_connected.value = true
      } else {
        current_user_is_connected.value = false
      }
      async function vote(voteType, bundleId) {
        if (current_user_is_connected.value == true) {
          const params = new URLSearchParams({ bundleId, voteType });
          const res = await fetch('/bundle/evaluate?' + params.toString());
          const data = await res.json()

          bundle.value.vote_up = data.vote_up
          bundle.value.vote_down = data.vote_down
        } else {
          window.location.href = `/account/login`;
        }

      }
      /**
       *          #########################
       *          #   security section    #
       *          #########################
       */

      const is_admin = ref(false)

      async function fetchCurrentUser() {
        const res = await fetch('/rule/get_current_user')
        if (res) {
          const data = await res.json()
          is_admin.value = data.user
        }
      }
      fetchCurrentUser()

      function parsedCVE(cveField) {
        if (!cveField) return [];

        // Tentative JSON (tableau ou string)
        try {
          const parsed = JSON.parse(cveField);
          if (Array.isArray(parsed)) return parsed;
          if (typeof parsed === "string") return [parsed];
        } catch (e) {
          // Ignore error, fallback below
        }

        // Format type: "{CVE-...,GHSA-...}" ou "CVE-..., GHSA-..."
        return cveField
          .replace(/[{}[\]]/g, "")        // enlève {}, []
          .split(",")                     // découpe multi-CVE
          .map(s => s.trim())             // nettoie
          .filter(s => s.length > 0);     // supprime vide
      }


      // --------------------------------------------
      // COULEURS
      // --------------------------------------------
      function getCVEColor(cve) {
        if (!cve) return "bg-dark";

        if (cve.startsWith("CVE")) return "bg-danger";
        if (cve.startsWith("GHSA")) return "bg-warning text-dark";
        if (cve.startsWith("PYSEC")) return "bg-info text-dark";
        if (cve.startsWith("GSD")) return "bg-secondary";
        if (cve.startsWith("GCVE")) return "bg-primary";
        if (cve.startsWith("RHSA")) return "bg-danger-subtle text-dark";
        if (cve.startsWith("CERTFR")) return "bg-success";
        if (cve.startsWith("cisco-sa")) return "bg-dark";
        if (cve.startsWith("wid-sec-w")) return "bg-secondary";
        if (cve.startsWith("msrc_CVE")) return "bg-purple";

        return "bg-dark"; // fallback
      }


      // --------------------------------------------
      // ICONES
      // --------------------------------------------
      function getCVEIcon(cve) {
        if (!cve) return "fas fa-exclamation-triangle";

        if (cve.startsWith("CVE")) return "fas fa-shield-alt";
        if (cve.startsWith("GHSA")) return "fas fa-bug";
        if (cve.startsWith("PYSEC")) return "fas fa-code";
        if (cve.startsWith("GSD")) return "fas fa-database";
        if (cve.startsWith("GCVE")) return "fas fa-globe";
        if (cve.startsWith("RHSA")) return "fas fa-lock";
        if (cve.startsWith("CERTFR")) return "fas fa-flag";
        if (cve.startsWith("cisco-sa")) return "fas fa-network-wired";
        if (cve.startsWith("wid-sec-w")) return "fas fa-exclamation-circle";
        if (cve.startsWith("msrc_CVE")) return "fas fa-shield-virus";

        return "fas fa-exclamation-triangle"; // fallback
      }


      // --------------------------------------------
      // UTILITAIRES
      // --------------------------------------------
      function getCVEPrefix(cve) {
        if (!cve) return "";
        return cve.split("-")[0].toUpperCase();
      }

      function getCVENumber(cve) {
        if (!cve) return "";
        // Enlève tout sauf la partie numérique
        return cve.replace(/^[A-Za-z_:-]+/, "").replace(/^-/, "");
      }

      function goTo(rule_id) {
        window.location.href = `/rule/detail_rule/${rule_id}`;
      }

      return {
        bundle,
        rules,
        message_list,
        bundle_id,
        is_admin,

        vote,
        edit_access,
        deleteBundle,
        saveNewDescription,
        DownloadBundle,
        current_user_is_connected,
        parsedCVE,
        getCVEColor,
        getCVEIcon,
        getCVEPrefix,
        getCVENumber,
        goTo
      };
    }
  }).mount('#main-container');
</script>
{% endblock %}