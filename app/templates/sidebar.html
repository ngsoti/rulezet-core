<div id="app">
   <div class="christmas-lights-container">
      <ul class="christmas-lights">
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
         <li></li>
      </ul>
   </div>
   <nav class="navbar navbar-expand-lg  sticky-top main-navbar shadow-sm py-2">
      <div class=" container-fluid px-4">

         <a href="/" class="navbar-brand d-flex align-items-center transition-transform">
            <img src="{{ url_for('static', filename='image/logo_rulezet_bg.png') }}" height="75" alt="RULEZET Logo">
         </a>

         <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarContent">
            <i class="fa-solid fa-bars"></i>
         </button>

         <div class="collapse navbar-collapse" id="navbarContent">
            <ul class=" navbar-nav mx-auto align-items-center gap-1">

               <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle custom-nav-link fw-bold" href="#" id="bundleDropdown" role="button"
                     data-bs-toggle="dropdown" aria-expanded="false">
                     <i class="fa-solid fa-box fa-fw me-1 text-primary"></i> Bundle
                  </a>
                  <ul class="dropdown-menu border-0 shadow-lg animate slideIn" aria-labelledby="bundleDropdown">
                     <li><a href="/bundle/create" class="dropdown-item py-2"><i
                              class="fa-solid fa-calendar-plus fa-fw me-2 text-muted"></i>Create Bundle</a></li>
                     <li><a href="/bundle/list" class="dropdown-item py-2"><i
                              class="fa-solid fa-clipboard-list fa-fw me-2 text-muted"></i>View Bundles</a></li>
                  </ul>
               </li>

               <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle custom-nav-link fw-bold" href="#" id="rulesDropdown" role="button"
                     data-bs-toggle="dropdown" aria-expanded="false">
                     <i class="fa-solid fa-shield-halved fa-fw me-1 text-primary"></i> Security Rules
                  </a>
                  <ul class="dropdown-menu border-0 shadow-lg animate slideIn" aria-labelledby="rulesDropdown">
                     <li><a class="dropdown-item py-2" href="/rule/rules_list"><i
                              class="fa-solid fa-list fa-fw me-2 text-muted"></i>Rules List</a></li>
                     {% if current_user.is_authenticated %}
                     <li>
                        <a class="dropdown-item py-2 position-relative d-flex justify-content-between align-items-center"
                           href="/rule/rule_propose_edit">
                           <span><i class="fa-solid fa-lightbulb fa-fw me-2 text-muted"></i>Rule Proposal</span>
                           <template v-if="changes_to_validate > 0">
                              <span class="badge rounded-pill bg-danger ms-2">[[ changes_to_validate ]]</span>
                           </template>
                        </a>
                     </li>
                     <li><a class="dropdown-item py-2" href="/rule/bad_rules_summary"><i
                              class="fa-solid fa-tags fa-fw me-2 text-muted"></i>Bad Rules</a></li>
                     <li><a class="dropdown-item py-2" href="/rule/create_rule"><i
                              class="fas fa-hammer fa-fw me-2 text-muted"></i>Add Rule</a></li>
                     <li><a class="dropdown-item py-2" href="/account/contributor"><i
                              class="fa-solid fa-user-group fa-fw me-2 text-muted"></i>Contributors</a></li>
                     {% if not current_user.is_admin() %}
                     <li>
                        <a href="/admin/request"
                           class="dropdown-item py-2 position-relative d-flex justify-content-between align-items-center">
                           <span><i class="fa-solid fa-envelope fa-fw me-2 text-muted"></i>Ownership Requests</span>
                           <template v-if="requests_to_validate > 0">
                              <span class="badge rounded-pill bg-danger ms-2">[[ requests_to_validate ]]</span>
                           </template>
                        </a>
                     </li>
                     {% endif %}
                     {% endif %}
                  </ul>
               </li>

               {% if current_user.is_authenticated %}
               <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle custom-nav-link fw-bold" href="#" id="githubDropdown" role="button"
                     data-bs-toggle="dropdown" aria-expanded="false">
                     <i class="fa-brands fa-github fa-fw me-1"></i> Github
                  </a>
                  <ul class="dropdown-menu border-0 shadow-lg animate slideIn" aria-labelledby="githubDropdown">
                     <li><a class="dropdown-item py-2" href="/rule/list_github_url"><i
                              class="fa-solid fa-list fa-fw me-2 text-muted"></i>Github List</a></li>
                     <li><a class="dropdown-item py-2" href="/rule/history_github_importer"><i
                              class="fa-solid fa-bars-progress fa-fw me-2 text-muted"></i>Manage Github</a></li>
                     <li><a class="dropdown-item py-2" href="/rule/create_rule?tab=github"><i
                              class="fa-solid fa-file-import fa-fw me-2 text-muted"></i>Import Rules</a></li>
                     <li>
                        <a class="dropdown-item py-2 d-flex justify-content-between align-items-center"
                           href="/rule/update_github/update_rules_from_github">
                           <span><i class="fa-solid fa-rotate fa-fw me-2 text-muted"></i>Update Rules</span>
                           <template v-if="update_to_validate > 0">
                              <span class="badge rounded-pill bg-danger ms-2">[[ update_to_validate ]]</span>
                           </template>
                        </a>
                     </li>
                  </ul>
               </li>
               {% endif %}

               {% if current_user.is_authenticated and current_user.is_admin() %}
               <li class="nav-item dropdown px-2">
                  <a class="nav-link dropdown-toggle custom-nav-link fw-bold" href="#" data-bs-toggle="dropdown">
                     <i class="fa-solid fa-lock fa-fw me-1 text-danger"></i> Admin
                  </a>
                  <ul class="dropdown-menu border-0 shadow-lg animate slideIn">
                     <li><a href="/account/all_users" class="dropdown-item py-2"><i
                              class="fa-solid fa-users fa-fw me-2 text-muted"></i>Users List</a></li>
                     <li><a href="/rule/rules_reported" class="dropdown-item py-2"><i
                              class="fa-solid fa-triangle-exclamation fa-fw me-2 text-muted"></i>Reported Rules</a></li>
                     <li>
                        <a href="/admin/request"
                           class="dropdown-item py-2 d-flex justify-content-between align-items-center">
                           <span><i class="fa-solid fa-envelope fa-fw me-2 text-muted"></i>Ownership Requests</span>
                           <template v-if="requests_to_validate > 0">
                              <span class="badge rounded-pill bg-danger">[[ requests_to_validate ]]</span>
                           </template>
                        </a>
                     </li>
                     <li><a class="dropdown-item py-2" href="/rule/manage_format_rule"><i
                              class="fa-solid fa-file-code fa-fw me-2 text-muted"></i>Manage Format</a></li>
                  </ul>
               </li>
               {% endif %}
            </ul>

            <div class="d-flex align-items-center gap-3 ms-auto">
               <button
                  class="btn btn-search-trigger d-none d-xl-flex align-items-center rounded-pill px-3 py-1 home-btn"
                  data-bs-toggle="offcanvas" href="#offcanvasSearch"
                  @click="fetchRules() ; fetchRulesFormats() ; giveFocus()">
                  <i class="fa-solid fa-magnifying-glass me-2 text-muted"></i>
                  <span class="text-muted small">Search rules...</span>
               </button>

               <div class="dropdown">
                  <a class="position-relative p-2 text-dark transition-hover" href="#" id="notificationsDropdown"
                     role="button" data-bs-toggle="dropdown" aria-expanded="false">
                     <i class="fa-solid fa-bell fs-5"></i>
                     <span v-if="total_notifications > 0"
                        class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-white rounded-circle pulse-alert"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-2 mt-3" style="min-width: 280px;">
                     <li class="dropdown-header fw-bold text-dark px-3 py-2">Quick Actions</li>
                     <li>
                        <hr class="dropdown-divider">
                     </li>
                     <template v-if="total_notifications === 0">
                        <li class="text-center text-muted small py-3">All caught up!</li>
                     </template>
                     <template v-else>
                        <li v-if="requests_to_validate > 0">
                           <a href="/admin/request"
                              class="dropdown-item rounded d-flex justify-content-between align-items-center py-2">
                              <span class="small"><i class="fa-solid fa-envelope me-2 text-primary"></i>Requests</span>
                              <span class="badge bg-danger rounded-pill">[[ requests_to_validate ]]</span>
                           </a>
                        </li>
                        <li v-if="changes_to_validate > 0">
                           <a href="/rule/rule_propose_edit"
                              class="dropdown-item rounded d-flex justify-content-between align-items-center py-2">
                              <span class="small"><i class="fa-solid fa-lightbulb me-2 text-warning"></i>Changes</span>
                              <span class="badge bg-danger rounded-pill">[[ changes_to_validate ]]</span>
                           </a>
                        </li>
                        <li v-if="repport_to_validate > 0">
                           <a href="/rule/rules_reported"
                              class="dropdown-item rounded d-flex justify-content-between align-items-center py-2">
                              <span class="small"><i
                                    class="fa-solid fa-triangle-exclamation me-2 text-danger"></i>Reports</span>
                              <span class="badge bg-danger rounded-pill">[[ repport_to_validate ]]</span>
                           </a>
                        </li>
                     </template>
                  </ul>
               </div>

               <div class="dropdown">
                  <a class="btn btn-profile d-flex align-items-center gap-2 rounded-pill ps-1 pe-3 py-1" href="#"
                     role="button" data-bs-toggle="dropdown" aria-expanded="false">
                     <div class="avatar-circle">
                        {% if current_user.is_authenticated %}
                        {{ current_user.get_first_name()[0].upper() }}
                        {% else %}
                        <i class="fa-solid fa-user"></i>
                        {% endif %}
                     </div>
                     <span class="fw-bold small d-none d-sm-inline">
                        {% if current_user.is_authenticated %}{{ current_user.get_first_name() }}{% else %}Profile{%
                        endif %}
                     </span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg mt-3 p-2">
                     {% if current_user.is_authenticated %}
                     <li><a href="/account/" class="dropdown-item rounded py-2"><i
                              class="fa-solid fa-user-circle me-2 text-muted"></i>Profile</a></li>
                     <li><a href="/rule/owner_rules" class="dropdown-item rounded py-2"><i
                              class="fa-solid fa-user-shield me-2 text-muted"></i>My Rules</a></li>
                     <li><a href="/account/favorite" class="dropdown-item rounded py-2"><i
                              class="fa-solid fa-star me-2 text-warning"></i>Favorites</a></li>
                     <li>
                        <hr class="dropdown-divider">
                     </li>
                     <li><a href="/account/logout" class="dropdown-item rounded py-2 text-danger fw-bold"><i
                              class="fa-solid fa-power-off me-2"></i>Logout</a></li>
                     {% else %}
                     <li><a href="/account/register" class="dropdown-item rounded py-2 fw-bold">Register</a></li>
                     <li><a href="/account/profil" class="dropdown-item rounded py-2">Login</a></li>
                     {% endif %}
                  </ul>
               </div>
            </div>
         </div>
      </div>
   </nav>
   <div class="offcanvas offcanvas-end border-0 shadow-lg" tabindex="-1" id="offcanvasSearch"
      aria-labelledby="offcanvasSearchLabel" style="width: 700px; background-color: var(--bg-color);">

      <div class="offcanvas-header  border-bottom py-4 px-4">
         <div class="d-flex align-items-center">
            <div class="bg-primary-subtle p-2 rounded-3 me-3">
               <i class="fa-solid fa-magnifying-glass text-primary fs-5"></i>
            </div>
            <div>
               <h5 id="offcanvasSearchLabel" class="fw-bold mb-0 text-dark">Search Rules</h5>
               <small class="text-muted">Find specific security detections</small>
            </div>
         </div>
         <button type="button" class="btn-close shadow-none" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>

      <div class="offcanvas-body p-4">
         <div class="search-container  p-3 rounded-4 shadow-sm mb-4">
            <div class="search-bar-container mb-4">
               <div class="input-group input-group-lg search-group">
                  <span class="input-group-text bg-white border-end-0 ps-4">
                     <i class="fa-solid fa-magnifying-glass text-primary opacity-75"></i>
                  </span>
                  <input type="text" v-model="searchQuery" @input="onSearchInput" id="searchInputCaneva"
                     @keyup.enter="onEnterKey" class="form-control border-start-0 ps-2 shadow-none fs-6 py-3"
                     placeholder="Search by keywords, CVE, or tags...">

                  <span class="input-group-text bg-white border-start-0 pe-4" v-if="searchQuery"
                     @click="searchQuery = ''; fetchRules()" style="cursor: pointer;">
                     <i class="fa-solid fa-xmark text-muted small"></i>
                  </span>
               </div>
            </div>

            <div class="row g-3 mb-4">
               <div class="col-md-3">
                  <label class="small fw-bold text-muted mb-1 ms-1">Sort by</label>
                  <select v-model="sortBy" class="form-select form-select-sm rounded-pill shadow-none"
                     @change="fetchRules()">
                     <option value="newest">Newest</option>
                     <option value="oldest">Oldest</option>
                     <option value="most_likes">Most Liked</option>
                     <option value="least_likes">Least Liked</option>
                  </select>
               </div>

               <div class="col-md-3">
                  <label class="small fw-bold text-muted mb-1 ms-1">Type</label>
                  <select v-model="ruleType" class="form-select form-select-sm rounded-pill shadow-none"
                     @change="fetchRules()">
                     <option value="">All Types</option>
                     <option v-for="format in rules_formats" :value="format.name" :key="format.id">
                        [[ format.name ]]
                     </option>
                  </select>
               </div>
            </div>
         </div>

         <div class="results-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-3 px-1">
               <span class="badge   rounded-pill fw-normal" v-if="rules_list && rules_list.rule">
                  [[ rules_list.rule.length ]] results found
               </span>
            </div>

            <div v-if="rules_list && rules_list.rule && rules_list.rule.length > 0" class="results-list">
               <a v-for="rule in rules_list.rule" :key="rule.id" :href="`/rule/detail_rule/${rule.id}`"
                  class="search-result-item d-flex align-items-center p-3 mb-2 text-decoration-none shadow-sm">
                  <div class="flex-shrink-0 me-3">
                     <div class="icon-box bg-light rounded-3 d-flex align-items-center justify-content-center"
                        style="width: 45px; height: 45px;">
                        <i class="fa-solid fa-file-code text-primary"></i>
                     </div>
                  </div>
                  <div class="flex-grow-1 min-width-0">
                     <h6 class="mb-0 fw-bold text-dark text-truncate">[[ rule.title ]]</h6>
                     <p class="mb-0 text-muted small text-truncate">[[ rule.description ]]</p>
                     <div>
                        <p class="mb-0 text-muted small text-truncate badge bg-primary-subtle">[[ rule.format ]]</p>
                        <!-- <div v-if="rule.cve_id && rule.cve_id !== 'None'" class="d-flex flex-wrap gap-1">
                           <a v-for="cve in parsedCVE(rule.cve_id)"
                              :href="'https://vulnerability.circl.lu/vuln/' + cve.toLowerCase()" target="_blank"
                              :class="['badge', 'text-decoration-none', getCVEColor(cve)]"
                              style="font-size: 0.75rem; font-weight: 500;">
                              [[ cve ]]
                           </a>
                        </div> -->
                     </div>

                  </div>
                  <div class="ms-2">
                     <span class="badge bg-primary  rounded-pill" style="font-size: 0.65rem;">[[ rule.type
                        ]]</span>
                  </div>
               </a>
            </div>

            <div v-else class="text-center py-5">
               <div class="mb-3 opacity-25">
                  <i class="fa-solid fa-database fa-3x"></i>
               </div>
               <h6 class="text-muted fw-bold">No rules match your search</h6>
               <p class="text-muted small">Try adjusting your keywords or filters.</p>
            </div>
         </div>
      </div>
   </div>
</div>

<script type="module">
   const { createApp, ref, onMounted, computed } = Vue
   createApp({
      delimiters: ['[[', ']]'],
      setup() {

         /**
          *    ###################
          *    #  Notification   #
          *    ###################
          * */

         const requests_to_validate = ref(0)
         const changes_to_validate = ref(0)
         const repport_to_validate = ref(0)
         const update_to_validate = ref(0)
         const total_notifications = computed(() =>
            Number(requests_to_validate.value || 0) +
            Number(changes_to_validate.value || 0) +
            Number(repport_to_validate.value || 0) +
            Number(update_to_validate.value || 0)
         )
         async function getNbRequestAdmin() {
            const res = await fetch('/request_to_check')
            const data = await res.json()
            requests_to_validate.value = data.count || 0
         }

         async function getNbChanges() {
            const res = await fetch('/rule/change_to_check')
            const data = await res.json()
            changes_to_validate.value = data.count || 0
         }

         async function getNbRepport() {
            const res = await fetch('/rule/repport_to_check')
            const data = await res.json()
            repport_to_validate.value = data.count || 0
         }

         async function getNbUpdate() {
            const res = await fetch('/rule/update_to_check')
            const data = await res.json()
            update_to_validate.value = data.count || 0
         }

         /**
          *    ############
          *    #  Search  #
          *    ############
          * */


         const searchQuery = ref('')
         const sortBy = ref('newest')
         const ruleType = ref('')

         const rules_formats = ref([])

         async function fetchRulesFormats() {
            const res = await fetch('/rule/get_rules_formats')
            const data = await res.json()
            if (res.status === 200) {
               rules_formats.value = data.formats
            }
         }

         const rules_list = ref([])

         async function fetchRules() {
            const params = new URLSearchParams({
               page: 1,
               search: searchQuery.value,
               sort_by: sortBy.value,
               rule_type: ruleType.value
            })

            const res = await fetch('/rule/get_rules_page_filter?' + params.toString())
            if (res.status === 200) {
               const data = await res.json()
               rules_list.value = data || []
            }

         }
         function giveFocus() {
            setTimeout(() => {
               const input = document.getElementById("searchInputCaneva");
               if (input) {
                  input.focus();
               }
            }, 400);
         }


         async function onSearchInput() {
            if (searchQuery.value.trim() === "") {
               await fetchRules()
            } else {
               await fetchRules()
            }
         }

         async function onEnterKey() {
            await fetchRules()
         }

         function parsedCVE(cveField) {
            if (!cveField) return [];
            try {
               const parsed = typeof cveField === 'string' ? JSON.parse(cveField) : cveField;
               return Array.isArray(parsed) ? parsed : [parsed];
            } catch (e) {
               return cveField.replace(/[{}]/g, "").split(",").map(s => s.trim()).filter(s => s !== "");
            }
         }

         function getCVEColor(cve) {
            const c = cve.toUpperCase();
            if (c.startsWith("CVE")) return "bg-danger";
            if (c.startsWith("GHSA")) return "bg-warning text-dark";
            if (c.startsWith("PYSEC")) return "bg-info text-dark";
            if (c.startsWith("RHSA") || c.startsWith("MS")) return "bg-purple";
            return "bg-secondary";
         }

         /**
          *    ################
          *    #   Fetch all  #
          *    ################
          * */

         onMounted(() => {
            getNbRequestAdmin()
            getNbChanges()
            getNbRepport()
            getNbUpdate()

         })

         //fetchRulesFormats(),
         //fetchRules()


         return {
            requests_to_validate,
            changes_to_validate,
            repport_to_validate,
            update_to_validate,
            total_notifications,


            searchQuery,
            sortBy,
            ruleType,
            rules_formats,
            rules_list,

            fetchRules,
            onSearchInput,
            onEnterKey,
            fetchRulesFormats,

            parsedCVE,
            getCVEColor,
            giveFocus
         }
      },
   }).mount('#app')
</script>