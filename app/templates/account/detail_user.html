{% extends 'base.html' %}

{% block content %}
{% if current_user.is_admin() %}
<div class="container my-5" id="main-container">
    <div v-if="current_user && current_user_donne" class="row g-4">
        <!-- User Profile Card -->
        <div class="col-md-6 card shadow p-4 mt-4 rounded-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h3 class="card-title mb-3"><i class="fas fa-user-circle me-2"></i>User Profile</h3>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>ID:</strong> [[ current_user.id ]]</li>
                        <li class="list-group-item"><strong>Name:</strong> [[ current_user.first_name ]] [[ current_user.last_name ]]</li>
                        <li class="list-group-item"><strong>Email:</strong> [[ current_user.email ]]</li>
                        <li class="list-group-item"><strong>Admin:</strong>
                            <span class="badge" :class="current_user.admin ? 'bg-success' : 'bg-secondary'">
                                [[ current_user.admin ? 'Yes' : 'No' ]]
                            </span>
                        </li>
                        <li class="list-group-item"><strong>Connected:</strong>
                            <span class="badge" :class="current_user.is_connected ? 'bg-success' : 'bg-danger'">
                                [[ current_user.is_connected ? 'Yes' : 'No' ]]
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Activity Summary Card -->
        <div class="col-md-6 card shadow p-4 mt-4 rounded-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h3 class="card-title mb-3"><i class="fas fa-chart-line me-2"></i>User Activity</h3>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Rules Created:</strong> [[ current_user_donne.rule_count ]]</li>
                        <li class="list-group-item"><strong>Total Upvotes:</strong> [[ current_user_donne.total_upvotes ]]</li>
                        <li class="list-group-item"><strong>Total Downvotes:</strong> [[ current_user_donne.total_downvotes ]]</li>
                        <li class="list-group-item"><strong>Formats Used:</strong>
                            <span v-for="fmt in current_user_donne.formats_used" class="badge bg-primary me-1">[[ fmt ]]</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card shadow p-4 mt-4 rounded-3" v-if="current_user_donne && current_user_donne.rules.length">
            <h3 class="mb-3"><i class="fas fa-scroll me-2"></i>User's Rules</h3>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">Title</th>
                            <th scope="col">Author</th>
                            <th scope="col">Format</th>
                            <th scope="col">Created</th>
                            <th scope="col">License</th>
                            <th scope="col">Votes</th>
                            <th scope="col">Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="rule in current_user_donne.rules" :key="rule.id">
                            <td>[[ rule.title ]]</td>
                            <td>[[ rule.author ]]</td>
                            <td><span class="badge bg-info text-dark">[[ rule.format ]]</span></td>
                            <td>[[ rule.creation_date ]]</td>
                            <td>[[ rule.license ]]</td>
                            <td>
                                <span class="text-success"><i class="fas fa-thumbs-up"></i> [[ rule.vote_up ]]</span>
                                <span class="text-danger ms-2"><i class="fas fa-thumbs-down"></i> [[ rule.vote_down ]]</span>
                            </td>
                            <td>
                                <a :href="'/rule/detail_rule/' + rule.id" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>


        <!-- Graph Section -->
        <div class="col-12 col-md-6 col-lg-4 mx-auto mt-4 card shadow p-4 mt-4 rounded-3" 
            v-if="current_user_donne && (current_user_donne.total_upvotes + current_user_donne.total_downvotes > 0)">
            <div class="card shadow-sm border-0">
                <div class="card-body p-3">
                    <h3 class="card-title mb-3 text-center">
                        <i class="fas fa-chart-pie me-2"></i>Activity Overview
                    </h3>
                    <div class="d-flex justify-content-center">
                        <canvas id="votesChart" style="max-width: 250px; max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endif %}
{% endblock %}

{% block script %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
const { createApp, ref, onMounted, watch , nextTick} = Vue;
import { display_toast } from '/static/js/toaster.js';

createApp({
    delimiters: ['[[', ']]'],
    setup() {
        const current_user = ref();
        const current_user_donne = ref();
        const userId = "{{ user_id }}";

        /******************fetch users section************************/
        async function fetchUser(user_id) {
            const params = new URLSearchParams({ user_id });
            const res = await fetch('/account/get_user?' + params.toString());
            if (res.status === 200) {
                const data = await res.json();
                if (data.success) {
                    current_user.value = data.user;
                }
            }
        }

        async function fetchUserInfo(user_id) {
            const params = new URLSearchParams({ user_id });
            const res = await fetch('/account/get_user_donne?' + params.toString());
            if (res.status === 200) {
                const data = await res.json();
                if (data.success) {
                    current_user_donne.value = data.donne;
                }
            }
        }


        fetchUser(userId);
        fetchUserInfo(userId);
        /******************fetch data section************************/
        function renderChart() {
            if (!current_user_donne.value) return;

            const upvotes = current_user_donne.value.total_upvotes || 0;
            const downvotes = current_user_donne.value.total_downvotes || 0;

            if ((upvotes + downvotes) === 0) return;

            const ctx = document.getElementById('votesChart');
            if (!ctx) return;

            const chart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Upvotes', 'Downvotes'],
                    datasets: [{
                        label: 'Activity Stats',
                        data: [upvotes, downvotes],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        
    
        watch(current_user_donne, async (val) => {
            if (val) {
                await nextTick();  
                renderChart();
            }
        });


        return {
            current_user,
            current_user_donne
        };
    }
}).mount('#main-container');
</script>
{% endblock %}
