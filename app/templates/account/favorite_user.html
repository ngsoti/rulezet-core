{% extends 'base.html' %}
{% block content %}
<div class="container py-5" id="main-container">
  <div class="text-center mb-5">
    <h1 class="fw-bold ">
      <i class="fas fa-star-half-alt"></i> Favorite Rules Explorer
    </h1>
    <p class="text-muted">Browse and manage your most loved detection rules.</p>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded shadow p-4 mb-5 border-start border-5 border-primary">
    <div class="row gy-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label fw-semibold">Search</label>
        <div class="input-group">
          <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
          <input
            type="text"
            v-model="searchQuery"
            @input="onSearchInput"
            @keyup.enter="onEnterKey"
            class="form-control"
            placeholder="Find a rule by name, description, etc.">
        </div>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Sort By</label>
        <select v-model="sortBy" class="form-select">
          <option value="newest">ğŸ†• Newest</option>
          <option value="oldest">ğŸ“… Oldest</option>
          <option value="most_likes">ğŸ‘ Most Liked</option>
          <option value="least_likes">ğŸ‘ Least Liked</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Rule Type</label>
        <select v-model="ruleType" class="form-select">
          <option value="">ğŸ“š All Types</option>
          <option value="yara">ğŸ§¬ YARA</option>
          <option value="sigma">ğŸ” SIGMA</option>
          <option value="zeek">ğŸŒ Zeek</option>
          <option value="suricata">ğŸ›¡ï¸ Suricata</option>
        </select>
      </div>

      <div class="col-md-2 d-grid">
        <button class="btn btn-outline-primary fw-semibold" @click="fetchRules(1)">
          <i class="fas fa-filter"></i> Filter
        </button>
      </div>
    </div>
  </div>

  <!-- Rules -->
  <template v-if="rules_list_favorite.length > 0">
    <div class="row g-4">
      <div class="col-md-6 col-lg-4" v-for="rule in rules_list_favorite" :key="rule.id">
        <div class="card border-0 shadow-sm h-100 rounded-4 overflow-hidden">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-code me-1"></i> [[ rule.title ]]
            </h5>
            <a @click="favorite(rule.id)" title="Toggle Favorite" class="text-warning fs-5">
              <i class="fa-solid fa-star" :class="{ 'text-warning': rule.is_favorited, 'text-white': !rule.is_favorited }"></i>
            </a>
          </div>
          <div class="card-body bg-light-subtle">
            <p class="small fst-italic mb-2">[[ rule.description ]]</p>
            <ul class="list-unstyled small mb-3 text-secondary">
              <li><i class="fas fa-user me-1"></i> <strong>Author:</strong> [[ rule.author ]]</li>
              <li><i class="fas fa-calendar-alt me-1"></i> <strong>Date:</strong> [[ rule.creation_date ]]</li>
              <li><i class="fas fa-code-branch me-1"></i> <strong>Type:</strong> [[ rule.format ]]</li>
              <li><i class="fas fa-copyright me-1"></i> <strong>License:</strong> [[ rule.license ]]</li>
              <li><i class="fas fa-link me-1"></i> <strong>Source:</strong>
                <a :href="rule.source" target="_blank">link</a></li>
              <li><i class="fas fa-thumbs-up me-1"></i> [[ rule.vote_up ]] / [[ rule.vote_down ]]</li>
            </ul>
            <a :href="'/rule/detail_rule/' + rule.id" class="btn btn-sm btn-outline-dark">
              <i class="fas fa-eye"></i> View Details
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <nav class="mt-4" aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item" :class="{ disabled: current_page === 1 }">
          <a class="page-link" href="#" @click.prevent="fetchRules(current_page - 1)">
            <i class="fas fa-angle-left"></i>
          </a>
        </li>
        <li class="page-item" v-for="page in visiblePages" :key="page" :class="{ active: current_page === page, disabled: page === '...' }">
          <a v-if="page !== '...'" class="page-link" href="#" @click.prevent="fetchRules(page)">[[ page ]]</a>
          <span v-else class="page-link">...</span>
        </li>
        <li class="page-item" :class="{ disabled: current_page === total_pages }">
          <a class="page-link" href="#" @click.prevent="fetchRules(current_page + 1)">
            <i class="fas fa-angle-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  </template>

  <!-- No rules -->
  <template v-else>
    <div class="alert alert-warning text-center mt-5 shadow-sm">
      <i class="fas fa-circle-info me-2"></i>
      [[ searchQuery ? 'No matching rules found.' : 'You have not marked any rules as favorite yet.' ]]
    </div>
  </template>
</div>
{% endblock %}


{% block script %}
<script type="module">
const { createApp, ref, computed } = Vue;
import { message_list } from '/static/js/toaster.js';

createApp({
  delimiters: ['[[', ']]'],
  setup() {
    /*###################################_Show_rules_favorites_##################################*/
    // fetch rules favorites pages
    const rules_list_favorite = ref([]);
    const current_page = ref(1);
    const total_pages = ref(1);

    // filter
    const searchQuery = ref('')
    const authorFilter = ref('')
    const sortBy = ref('newest')
    const ruleType = ref("");
    /**
     *          ####################
     *          #   show rules     #
     *          ####################
     * */

    async function fetchRules(page) {
      const params = new URLSearchParams({
          page,
          search: searchQuery.value,
          author: authorFilter.value,
          sort_by: sortBy.value,
          rule_type: ruleType.value
        })
      const res = await fetch(`/account/favorite/get_rules_page_favorite?` + params.toString());
      const data = await res.json();
      if(res){
        rules_list_favorite.value = data.rule;
        current_page.value = page;
        total_pages.value = data.total_pages;
      }
      
    }
    fetchRules(1);

    /**
     *          ################################
     *          #   remove rules from favorite #
     *          ################################
     * */


    async function favorite(rule_id) {
      const res = await fetch(`/rule/favorite/${rule_id}`);
      const data = await res.json();
      
      if (res.ok) {
        const rule = rules_list_favorite.value.find(r => r.id === rule_id);
        if (rule) {
          rule.is_favorited = data.is_favorited;
          rules_list_favorite.value = rules_list_favorite.value.filter(rule => rule.id !== rule_id);
        }
      } else {
        console.error('Failed to update favorite status.');
      }
    }

     /**
     *          #################################
     *          #   filters rules from favorite #
     *          #################################
     * */
    async function onSearchInput() {
        if (searchQuery.value.trim() === "") {
          await fetchRules(1)
        } else {
          await fetchRules(1)
        }
      }

    async function onEnterKey() {
      await fetchRules(1)
    }

    const visiblePages = computed(() => {
        const pages = []
        const total = total_pages.value
        const current = current_page.value
        if (total <= 7) {
          for (let i = 1; i <= total; i++) pages.push(i)
        } else {
          if (current <= 4) {
            pages.push(1, 2, 3, 4, 5, '...', total)
          } else if (current >= total - 3) {
            pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
          } else {
            pages.push(1, '...', current - 1, current, current + 1, '...', total)
          }
        }
        return pages
      })

    return {
      authorFilter,
      searchQuery,
      sortBy,
      ruleType,

      rules_list_favorite,
      current_page,
      total_pages,

      fetchRules,
      favorite,
      onEnterKey,
      onSearchInput,

      visiblePages
    };
  }
}).mount('#main-container');
</script>
{% endblock %}
