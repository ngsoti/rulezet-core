{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-5" id="main-container">

  <!-- Title -->
  <div class="mb-4 border-bottom pb-3">
    <h2 class="fw-bold mb-1 text-primary text-center">GitHub Project URLs</h2>
    <div class="mx-auto" style="width: 60px; height: 4px; background-color: #0d6efd; border-radius: 2px;"></div>
    <p class="text-muted mt-2">
      Explore and discover GitHub project URLs associated with our detection rules. Use the search bar to quickly find specific URLs.
    </p>
  </div>

  <!-- Search bar -->
  <div class="d-flex justify-content-center mb-4">
    <div class="input-group  shadow-sm rounded">
      <span class="input-group-text bg-white border-end-0">
        <i class="fa-solid fa-magnifying-glass text-muted"></i>
      </span>
      <input v-model="searchQuery" @keyup.enter="fetchUrlGithub(1)"
             class="form-control border-start-0 rounded-end" placeholder="Search for GitHub URLs..." 
             @input="onSearchInput">
    </div>
  </div>
  <p class="text-center mt-3 text-muted" v-if="!loading">Total URLs found: [[ total_url ]]</p>

  <!-- Loading Spinner -->
  <div v-if="loading" class="d-flex justify-content-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- GitHub URLs Card -->
  <div class="row g-3" v-if="!loading">
    <template v-if="github_url.length > 0">

      <div class="col-12" v-for="(url, index) in github_url" :key="index" style="cursor: pointer;">
        <div class="card shadow-sm hover-shadow cursor-pointer" @click="goto(url.url)">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-1">
                [[ index + 1 ]]. <span class="text-truncate" style="max-width: 70vw;">[[ url.url ]]</span>
              </h5>
              <span class="badge bg-primary">Rule count: [[ url.rule_count ]]</span>
            </div>
            <i class="fa-solid fa-arrow-right text-primary fa-lg"></i>
          </div>
        </div>
      </div>

    </template>

    <template v-else>
      <div class="col-12">
        <div class="alert alert-warning shadow-sm text-center" role="alert">
          No GitHub URLs found.
        </div>
      </div>
    </template>
  </div>

  <!-- Pagination -->
  <nav v-if="total_pages > 1 && !loading" aria-label="GitHub pagination" class="mt-4">
    <ul class="pagination justify-content-center shadow-sm rounded p-2 bg-white">
      <li class="page-item" :class="{ disabled: current_page === 1 }">
        <button class="page-link" @click="fetchUrlGithub(current_page - 1)" :disabled="current_page === 1">Previous</button>
      </li>

      <li v-for="page in visiblePages" :key="page"
          class="page-item"
          :class="{ active: page === current_page, disabled: page === '...' }">
        <button class="page-link" v-if="page !== '...'" @click="fetchUrlGithub(page)">[[ page ]]</button>
        <span class="page-link" v-else>...</span>
      </li>

      <li class="page-item" :class="{ disabled: current_page === total_pages }">
        <button class="page-link" @click="fetchUrlGithub(current_page + 1)" :disabled="current_page === total_pages">Next</button>
      </li>
    </ul>
  </nav>

  

</div>
{% endblock %}

{% block script %}
<script type="module">
const { createApp, ref, computed } = Vue
import { display_toast, prepare_toast, message_list, display_prepared_toast } from '/static/js/toaster.js'

createApp({
  delimiters: ['[[', ']]'],
  setup() {
    const github_url = ref([])
    const total_url = ref(0)
    const current_page = ref(1)
    const total_pages = ref(1)
    const searchQuery = ref('')
    const loading = ref(true)

    async function fetchUrlGithub(page) {
      loading.value = true
      const params = new URLSearchParams({
        page,
        search: searchQuery.value || ''
      })

      const res = await fetch('/rule/get_url_github?' + params.toString())
      const data = await res.json()

      if (res.status === 200) {
        github_url.value = data.github_url || []
        total_url.value = data.total_url || 0
        total_pages.value = data.total_pages || 1
        current_page.value = page
      } else {
        github_url.value = []
        total_url.value = 0
        total_pages.value = 1
      }
      loading.value = false
    }

    fetchUrlGithub(1)

    const visiblePages = computed(() => {
      const pages = []
      const total = total_pages.value
      const current = current_page.value
      if (total <= 7) {
        for (let i = 1; i <= total; i++) pages.push(i)
      } else {
        if (current <= 4) {
          pages.push(1, 2, 3, 4, 5, '...', total)
        } else if (current >= total - 3) {
          pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
        } else {
          pages.push(1, '...', current - 1, current, current + 1, '...', total)
        }
      }
      return pages
    })

    async function onSearchInput() {
        await fetchUrlGithub(1)
    }

    function goto(url){
        const params = new URLSearchParams({ url })
        window.location.href = `/rule/github_detail?`+ params.toString()
    }

    return {
      github_url,
      total_url,
      total_pages,
      current_page,
      searchQuery,
      visiblePages,
      fetchUrlGithub,
      onSearchInput,
      goto,
      loading
    }
  }
}).mount('#main-container')
</script>
{% endblock %}
