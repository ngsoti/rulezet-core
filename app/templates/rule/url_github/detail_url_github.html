{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-5" id="main-container">

  <div class="mb-4 border-bottom pb-3">
    <!-- Title principal -->
    <h2 class="fw-bold mb-2 text-center text-primary">GitHub Rules Dashboard</h2>
    <div class="mx-auto mb-3" style="width: 80px; height: 5px; background-color: #0d6efd; border-radius: 2px;"></div>

    <!-- URL card -->
    <div class="card shadow-sm mx-auto hover-shadow cursor-pointer" 
        style="transition: transform 0.2s;" >
      <div class="card-body text-truncate">
        <i class="fa-brands fa-github me-2 text-dark"></i> Source URL:
        <strong><a href="{{ url }}" target="_blank" class="stretched-link"></a> {{ url }}</strong>
      </div>
    </div>
  </div>


  <!-- Search bar -->
  <div class="d-flex justify-content-center mb-4">
    <div class="input-group shadow-sm rounded">
      <span class="input-group-text bg-white border-end-0">
        <i class="fa-solid fa-magnifying-glass text-muted"></i>
      </span>
      <input v-model="searchQuery" @keyup.enter="fetchRuleUrlGithub(1)"
             class="form-control border-start-0 rounded-end" placeholder="Search rules..." 
             @input="onSearchInput">
    </div>
  </div>
  <p class="text-center mt-3 text-muted" v-if="!loading">Total rules found: [[ total_rule ]]</p>
  <!-- Loading Spinner -->
  <div v-if="loading" class="d-flex justify-content-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive" v-if="!loading">
    <table class="table table-hover table-striped align-middle shadow-sm rounded">
      <thead class="table-light">
        <tr>
          <th scope="col" class="text-center">#</th>
          <th scope="col">Title</th>
          <th scope="col">Author</th>
          <th scope="col">Description</th>
          <th scope="col">Format</th>
          <th scope="col">Creation Date</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(rule, index) in rule_github_url" :key="rule.id"
            @click="goto(rule.id)" style="cursor: pointer;">
          <td class="text-center">[[ index + 1 + (current_page - 1) * 20 ]]</td>
          <td>[[ rule.title ]]</td>
          <td>[[ rule.author ]]</td>
          <td class="text-truncate" style="max-width: 200px;">[[ rule.description ]]</td>
          <td> 
            <span class="badge bg-primary">
              [[ rule.format ]]
            </span>
          </td>
          <td>[[ rule.creation_date ]]</td>
        </tr>
      </tbody>
    </table>
    <div v-if="rule_github_url.length === 0" class="alert alert-warning text-center shadow-sm mt-3">
      No rules found.
    </div>
  </div>

  <!-- Pagination -->
  <nav v-if="total_pages > 1 && !loading" aria-label="Rule pagination" class="mt-4">
    <ul class="pagination justify-content-center shadow-sm rounded p-2 bg-white">
      <li class="page-item" :class="{ disabled: current_page === 1 }">
        <button class="page-link" @click="fetchRuleUrlGithub(current_page - 1)" :disabled="current_page === 1">Previous</button>
      </li>

      <li v-for="page in visiblePages" :key="page"
          class="page-item"
          :class="{ active: page === current_page, disabled: page === '...' }">
        <button class="page-link" v-if="page !== '...'" @click="fetchRuleUrlGithub(page)">[[ page ]]</button>
        <span class="page-link" v-else>...</span>
      </li>

      <li class="page-item" :class="{ disabled: current_page === total_pages }">
        <button class="page-link" @click="fetchRuleUrlGithub(current_page + 1)" :disabled="current_page === total_pages">Next</button>
      </li>
    </ul>
  </nav>

  

</div>
{% endblock %}

{% block script %}
<script type="module">
const { createApp, ref, computed } = Vue
import { display_toast, prepare_toast, message_list, display_prepared_toast } from '/static/js/toaster.js'

createApp({
  delimiters: ['[[', ']]'],
  setup() {
    const rule_github_url = ref([])
    const total_rule = ref(0)
    const current_page = ref(1)
    const total_pages = ref(1)
    const searchQuery = ref('')
    const loading = ref(true)

    async function fetchRuleUrlGithub(page) {
      loading.value = true
      const params = new URLSearchParams({
        page,
        search: searchQuery.value || '',
        url: "{{ url }}"
      })

      const res = await fetch('/rule/get_rule_url_github?' + params.toString())
      const data = await res.json()

      if (res.status === 200) {
        rule_github_url.value = data.rule_github_url || []
        total_rule.value = data.total_rule || 0
        total_pages.value = data.total_pages || 1
        current_page.value = page
      } else {
        rule_github_url.value = []
        total_rule.value = 0
        total_pages.value = 1
      }
      loading.value = false
    }

    fetchRuleUrlGithub(1)

    const visiblePages = computed(() => {
      const pages = []
      const total = total_pages.value
      const current = current_page.value
      if (total <= 7) {
        for (let i = 1; i <= total; i++) pages.push(i)
      } else {
        if (current <= 4) {
          pages.push(1, 2, 3, 4, 5, '...', total)
        } else if (current >= total - 3) {
          pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
        } else {
          pages.push(1, '...', current - 1, current, current + 1, '...', total)
        }
      }
      return pages
    })

    async function onSearchInput() {
        await fetchRuleUrlGithub(1)
    }

    function goto(id){
        window.location.href = "/rule/detail_rule/"+ id
    }

    return {
      rule_github_url,
      total_rule,
      total_pages,
      current_page,
      searchQuery,
      visiblePages,
      fetchRuleUrlGithub,
      onSearchInput,
      goto,
      loading
    }
  }
}).mount('#main-container')
</script>
{% endblock %}
