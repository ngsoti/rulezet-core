{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-4" id="main-container">
    <h3 class="mb-4 text-center">Rules for GitHub URL: {{ url }}</h3>

    <!-- Search bar -->
    <div class="d-flex justify-content-center mb-3">
        <input v-model="searchQuery" @keyup.enter="fetchRuleUrlGithub(1)"
               class="form-control w-50" placeholder="Search rules..." @input="onSearchInput">
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col" class="text-center">#</th>
                    <th scope="col">Title</th>
                    <th scope="col">Author</th>
                    <th scope="col">Description</th>
                    <th scope="col">Format</th>
                    <th scope="col">Creation Date</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(rule, index) in rule_github_url" :key="rule.id"
                    @click=goto(rule.id)
                    style="cursor: pointer;">
                    <td class="text-center">[[ index + 1 + (current_page - 1) * 20 ]]</td>
                    <td>[[ rule.title ]]</td>
                    <td>[[ rule.author ]]</td>
                    <td>[[ rule.description ]]</td>
                    <td>[[ rule.format ]]</td>
                    <td>[[ rule.creation_date ]]</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav v-if="total_pages > 1" aria-label="Rule pagination">
        <ul class="pagination justify-content-center">
            <li class="page-item" :class="{ disabled: current_page === 1 }">
                <button class="page-link" @click="fetchRuleUrlGithub(current_page - 1)" :disabled="current_page === 1">Previous</button>
            </li>

            <li v-for="page in visiblePages" :key="page"
                class="page-item"
                :class="{ active: page === current_page, disabled: page === '...' }">
                <button class="page-link" v-if="page !== '...'" @click="fetchRuleUrlGithub(page)">[[ page ]]</button>
                <span class="page-link" v-else>...</span>
            </li>

            <li class="page-item" :class="{ disabled: current_page === total_pages }">
                <button class="page-link" @click="fetchRuleUrlGithub(current_page + 1)" :disabled="current_page === total_pages">Next</button>
            </li>
        </ul>
    </nav>

    <p class="text-center mt-3 text-muted">Total rules found: [[ total_rule ]]</p>
</div>
{% endblock %}


{% block script %}
<script type="module">
const { createApp, ref, computed } = Vue
import { display_toast,   message_list, display_prepared_toast } from '/static/js/toaster.js'

createApp({
  delimiters: ['[[', ']]'],
  setup() {
    const rule_github_url = ref([])
    const total_rule = ref(0)
    const current_page = ref(1)
    const total_pages = ref(1)
    const searchQuery = ref('')

    async function fetchRuleUrlGithub(page) {
      const params = new URLSearchParams({
        page,
        search: searchQuery.value || '',
        url: "{{ url }}"
      })

      const res = await fetch('/rule/get_rule_url_github?' + params.toString())
      const data = await res.json()

      if (res.status === 200) {
        rule_github_url.value = data.rule_github_url || []
        total_rule.value = data.total_rule || 0
        total_pages.value = data.total_pages || 1
        current_page.value = page
      } else {
        rule_github_url.value = []
        total_rule.value = 0
        total_pages.value = 1
      }
    }

    fetchRuleUrlGithub(1)

    const visiblePages = computed(() => {
      const pages = []
      const total = total_pages.value
      const current = current_page.value
      if (total <= 7) {
        for (let i = 1; i <= total; i++) pages.push(i)
      } else {
        if (current <= 4) {
          pages.push(1, 2, 3, 4, 5, '...', total)
        } else if (current >= total - 3) {
          pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
        } else {
          pages.push(1, '...', current - 1, current, current + 1, '...', total)
        }
      }
      return pages
    })

    async function onSearchInput() {
        if (searchQuery.value.trim() === "") {
          await fetchRuleUrlGithub(1)
        } else {
          await fetchRuleUrlGithub(1)
        }
      }

      async function onEnterKey() {
        await fetchRuleUrlGithub(1)
      }

    function goto(id){
        window.location.href = "/rule/detail_rule/"+ id
    }

    return {
      rule_github_url,
      total_rule,
      total_pages,
      current_page,
      searchQuery,
      visiblePages,
      fetchRuleUrlGithub,
      onSearchInput,
      goto
    }
  }
}).mount('#main-container')
</script>
{% endblock %}
