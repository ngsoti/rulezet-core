{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-4" id="main-container">
    <div class="mb-4 border-bottom pb-3">
        <h2 class="mb-3 text-center text-primary fw-bold">
            GitHub Rules Management
            <div class="mx-auto" style="width: 60px; height: 4px; background-color: #0d6efd; border-radius: 2px;"></div>
        </h2>
        <p class="text-muted mt-2 text-center">
            Monitor and manage your imported rule sets from GitHub.
            Use the tabs below to view all imported repositories and check for available updates.
            You can also track ongoing imports or updates in real time.
        </p>
    </div>
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-outline-primary float-end position-relative" data-bs-toggle="modal"
        data-bs-target="#staticBackdrop">
        Running
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" v-cloak>
            [[running_sessions.length + running_sessions_update.length]]
            <span class="visually-hidden">unread messages</span>
        </span>
    </button>

    <ul class="nav nav-underline justify-content-center w-100 mb-3" id="exampleTabs" role="tablist">
        <li class="nav-item flex-fill text-center">
            <a class="nav-link active" id="github-tab" data-bs-toggle="tab" href="#github-pane" role="tab"
                aria-controls="github" aria-selected="true" style="color: var(--text-color);">
                Imported Repositories
            </a>
        </li>
        <li class="nav-item flex-fill text-center">
            <a class="nav-link" id="rule-tab" data-bs-toggle="tab" href="#rule-pane" role="tab"
                aria-controls="rule-pane" aria-selected="false" style="color: var(--text-color);">
                Updates & Status
            </a>
        </li>
    </ul>

    <div class="tab-content" id="exampleTabsContent">
        <div class="tab-pane fade show active" id="github-pane" role="tabpanel" aria-labelledby="github-tab">
            <div class="card p-3">
                <template v-if="history_list.length === 0">
                    <div class="alert alert-info text-center" role="alert">
                        No history found.
                    </div>
                </template>


                <!-- Table -->
                <template v-if="history_list.length > 0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="text-center">#</th>
                                    <th scope="col">GitHub Importer</th>
                                    <th scope="col">Imported</th>
                                    <th scope="col">Bad rules</th>
                                    <th scope="col">Skipped</th>
                                    <th scope="col">Date</th>
                                    {% if current_user.is_admin() %}
                                    <th scope="col">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(history, index) in history_list" :key="index" @click="goto(history.uuid)"
                                    style="cursor: pointer;">
                                    <td class="text-center">[[ index + 1 ]]</td>
                                    <td>[[ history.info.repo_url ]]</td>
                                    <td>[[ history.imported ]]</td>
                                    <td>[[ history.bad_rules ]]</td>
                                    <td>[[ history.skipped ]]</td>
                                    <td>[[ history.query_date ]]</td>
                                    {% if current_user.is_admin() %}
                                    <!-- delete button with modal-->
                                    <td><button class="dropdown-item rounded-2 text-danger" data-bs-toggle="modal"
                                            :data-bs-target="'#delete_import_modal_'+history.uuid" @click.stop>
                                            <i class="fa-solid fa-trash me-2"></i>
                                        </button>
                                        <div class="modal fade" :id="'delete_import_modal_'+history.uuid" tabindex="-1"
                                            aria-hidden="true" @click.stop>
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content border-0 shadow-lg"
                                                    style="border-radius: 15px;">
                                                    <div class="modal-header border-0 pb-0">
                                                        <h5 class="modal-title fw-bold">Confirm Deletion</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            @click.stop></button>
                                                    </div>
                                                    <div class="modal-body py-4 text-center">
                                                        <div class="text-danger mb-3"><i
                                                                class="fas fa-exclamation-triangle fa-3x"></i>
                                                        </div>
                                                        <p class="mb-0">Are you sure you want to delete <br><strong>[[
                                                                history.info.repo_url
                                                                ]]</strong> ?
                                                        </p>
                                                    </div>
                                                    <div class="modal-footer border-0 pt-0">
                                                        <button type="button" class="btn btn-light rounded-pill px-4"
                                                            data-bs-dismiss="modal" @click.stop>Cancel</button>
                                                        <button class="btn btn-danger rounded-pill px-4"
                                                            @click="deleteImportHistory(history.uuid, index)"
                                                            data-bs-dismiss="modal" @click.stop>
                                                            Confirm Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </template>


                <!-- Pagination -->
                <nav v-if="total_pages > 1" aria-label="GitHub pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" :class="{ disabled: current_page === 1 }">
                            <button class="page-link" @click="fetchGithubImporter(current_page - 1)"
                                :disabled="current_page === 1">Previous</button>
                        </li>

                        <li v-for="page in visiblePages" :key="page" class="page-item"
                            :class="{ active: page === current_page, disabled: page === '...' }">
                            <button class="page-link" v-if="page !== '...'" @click="fetchGithubImporter(page)">[[ page
                                ]]</button>
                            <span class="page-link" v-else>...</span>
                        </li>

                        <li class="page-item" :class="{ disabled: current_page === total_pages }">
                            <button class="page-link" @click="fetchGithubImporter(current_page + 1)"
                                :disabled="current_page === total_pages">Next</button>
                        </li>
                    </ul>
                </nav>

                <p class="text-center mt-3 text-muted">Total history found: [[ total_history ]]</p>
            </div>
        </div>
        <div class="tab-pane fade" id="rule-pane" role="tabpanel" aria-labelledby="rule-tab">
            <div class="card p-3">
                <template v-if="history_list_update.length === 0">
                    <div class="alert alert-info text-center" role="alert">
                        No history found.
                    </div>
                </template>


                <!-- Table -->
                <template v-if="history_list_update.length > 0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="text-center">#</th>
                                    <th scope="col">URLs / Rules</th>
                                    <th scope="col" class="text-center">Found</th>
                                    <th scope="col" class="text-center">New Rules</th>
                                    <th scope="col" class="text-center">Updated</th>
                                    <th scope="col" class="text-center">Mode</th>
                                    <th scope="col" class="text-center">Date</th>
                                    {% if current_user.is_admin() %}
                                    <th scope="col">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(history, index) in history_list_update" :key="history.uuid"
                                    @click="gotoUpdate(history.uuid)" style="cursor: pointer;" :class="{
                                'table-info': history.mode === 'by_url',
                                'table-warning': history.mode === 'by_rule',
                                'table-light': !['by_url', 'by_rule'].includes(history.mode)
                            }">
                                    <td class="text-center">[[ index + 1 ]]</td>

                                    <!-- GitHub Repositories -->
                                    <td>
                                        <template v-if="history.mode === 'by_url'">
                                            <div v-if="Array.isArray(history.repo_sources)">
                                                <span v-for="(repo, rIndex) in history.repo_sources" :key="rIndex"
                                                    class="badge bg-secondary me-1">
                                                    [[ repo ]]
                                                </span>
                                            </div>
                                            <div v-else>
                                                [[ history.info.repo_url || '—' ]]
                                            </div>
                                        </template>
                                        <template v-else>
                                            <div v-if="Array.isArray(history.rule_name_by_rule_mode)">
                                                <span v-for="(repo, rIndex) in history.rule_name_by_rule_mode"
                                                    :key="rIndex" class="badge bg-secondary me-1">
                                                    [[ repo ]]
                                                </span>
                                            </div>
                                            <div v-else>
                                                [[ history.info.repo_url || '—' ]]
                                            </div>
                                        </template>


                                    </td>

                                    <td class="text-center">
                                        [[ history.found ?? 0 ]]
                                    </td>
                                    <td class="text-center">
                                        [[ history.new_rules ?? 0 ]]
                                    </td>
                                    <td class="text-center">
                                        [[ history.updated ?? 0 ]]
                                    </td>
                                    <td class="text-center text-capitalize">
                                        <template v-if="history.mode === 'by_url'">
                                            <span class="badge bg-info text-dark">By URL</span>
                                        </template>
                                        <template v-else>
                                            <span class="badge bg-warning text-dark">By Rule</span>
                                        </template>
                                    </td>
                                    <td class="text-center">
                                        [[ history.query_date ]]
                                    </td>
                                    {% if current_user.is_admin() %}
                                    <!-- delete button with modal-->
                                    <td><button class="dropdown-item rounded-2 text-danger" data-bs-toggle="modal"
                                            :data-bs-target="'#delete_update_modal_'+history.uuid" @click.stop>
                                            <i class="fa-solid fa-trash me-2"></i>
                                        </button>
                                        <div class="modal fade" :id="'delete_update_modal_'+history.uuid" tabindex="-1"
                                            aria-hidden="true" @click.stop>
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content border-0 shadow-lg"
                                                    style="border-radius: 15px;">
                                                    <div class="modal-header border-0 pb-0">
                                                        <h5 class="modal-title fw-bold">Confirm Deletion</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            @click.stop></button>
                                                    </div>
                                                    <div class="modal-body py-4 text-center">
                                                        <div class="text-danger mb-3"><i
                                                                class="fas fa-exclamation-triangle fa-3x"></i>
                                                        </div>
                                                        <p class="mb-0">Are you sure you want to delete <br><strong>[[
                                                                history.info.repo_url
                                                                ]]</strong> ?
                                                        </p>
                                                    </div>
                                                    <div class="modal-footer border-0 pt-0">
                                                        <button type="button" class="btn btn-light rounded-pill px-4"
                                                            data-bs-dismiss="modal" @click.stop>Cancel</button>
                                                        <button class="btn btn-danger rounded-pill px-4"
                                                            @click="deleteUpdateHistory(history.uuid, index)"
                                                            data-bs-dismiss="modal" @click.stop>
                                                            Confirm Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </template>



                <!-- Pagination -->
                <nav v-if="total_pages_update > 1" aria-label="GitHub pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" :class="{ disabled: current_page_update === 1 }">
                            <button class="page-link" @click="fetchGithubUpdater(current_page_update - 1)"
                                :disabled="current_page_update === 1">Previous</button>
                        </li>

                        <li v-for="page in visiblePagesUpdate" :key="page" class="page-item"
                            :class="{ active: page === current_page_update, disabled: page === '...' }">
                            <button class="page-link" v-if="page !== '...'" @click="fetchGithubUpdater(page)">[[ page
                                ]]</button>
                            <span class="page-link" v-else>...</span>
                        </li>

                        <li class="page-item" :class="{ disabled: current_page_update === total_pages_update }">
                            <button class="page-link" @click="fetchGithubUpdater(current_page_update + 1)"
                                :disabled="current_page_update === total_pages">Next</button>
                        </li>
                    </ul>
                </nav>

                <p class="text-center mt-3 text-muted">Total history found: [[ total_history_update ]]</p>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Running Sessions</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 50px;">#</th>
                                    <th>Repository / Source</th>
                                    <th class="text-center">Type</th>
                                    <th class="text-center">Mode</th>
                                    <th class="text-center">Started By</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Import sessions -->
                                <tr v-for="(running, index) in running_sessions" :key="'import-' + index"
                                    @click="goto(running.uuid)" style="cursor: pointer;" class="table-info">
                                    <td class="text-center">[[ index + 1 ]]</td>
                                    <td>[[ running.info.repo_url || (running.info.repo_sources?.join(', ') || 'N/A') ]]
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">Import</span>
                                    </td>
                                    <td class="text-center text-capitalize">[[ running.info.mode || '-' ]]</td>
                                    <td class="text-center">[[ running.info.initiated_by || 'Unknown' ]]</td>
                                </tr>

                                <!-- Update sessions -->
                                <tr v-for="(running, index) in running_sessions_update" :key="'update-' + index"
                                    @click="gotoUpdate(running.uuid)" style="cursor: pointer;" class="table-warning">
                                    <td class="text-center">[[ running_sessions.length + index + 1 ]]</td>
                                    <td>[[ running.info.repo_url || (running.info.repo_sources?.join(', ') || 'N/A') ]]
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning text-dark">Update</span>
                                    </td>
                                    <td class="text-center text-capitalize">[[ running.info.mode || '-' ]]</td>
                                    <td class="text-center">[[ running.info.initiated_by || 'Unknown' ]]</td>
                                </tr>

                                <!-- No sessions -->
                                <tr v-if="running_sessions.length === 0 && running_sessions_update.length === 0">
                                    <td colspan="5" class="text-center text-muted py-3">
                                        No running sessions at the moment.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>



</div>
{% endblock %}


{% block script %}
<script type="module">
    const { createApp, ref, computed } = Vue
    import { message_list, display_toast, create_message } from '/static/js/toaster.js'

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            //  #############################
            //  #       Importer section    #
            //  #############################

            const history_list = ref([])
            const total_history = ref(0)
            const current_page = ref(1)
            const total_pages = ref(1)
            const running_sessions = ref({})

            async function fetchGithubImporter(page) {
                const params = new URLSearchParams({
                    page
                })

                const res = await fetch('/rule/history_github_importer/list?' + params.toString())
                const data = await res.json()

                if (res.status === 200) {
                    history_list.value = data.history || []
                    total_history.value = data.total_history || 0
                    total_pages.value = data.total_pages || 1
                    current_page.value = page
                } else {
                    history_list.value = []
                    total_history.value = 0
                    total_pages.value = 1
                }
            }

            fetchGithubImporter(1)

            async function fetchSessionRunning() {
                const res = await fetch('/rule/import_get_session_running')

                if (await res.status === 200) {
                    const data = await res.json()
                    running_sessions.value = data.import_sessions
                    running_sessions_update.value = data.update_sessions
                } else {
                    display_toast(res)
                }
            }
            fetchSessionRunning()

            const visiblePages = computed(() => {
                const pages = []
                const total = total_pages.value
                const current = current_page.value
                if (total <= 7) {
                    for (let i = 1; i <= total; i++) pages.push(i)
                } else {
                    if (current <= 4) {
                        pages.push(1, 2, 3, 4, 5, '...', total)
                    } else if (current >= total - 3) {
                        pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
                    } else {
                        pages.push(1, '...', current - 1, current, current + 1, '...', total)
                    }
                }
                return pages
            })

            async function deleteImportHistory(uuid, index) {
                const params = new URLSearchParams({
                    uuid
                })


                const res = await fetch('/rule/history_github_importer/delete?' + params.toString())
                const data = await res.json()
                if (res.status == 200) {
                    var myModalEl = document.getElementById('delete_import_modal_' + uuid);
                    var modal = bootstrap.Modal.getInstance(myModalEl)
                    modal.hide();

                    fetchGithubImporter(current_page.value)
                    fetchSessionRunning()
                }
                create_message(data.message, data.toast_class)
            }

            //  #############################
            //  #       Updater section     #
            //  #############################

            const history_list_update = ref([])
            const total_history_update = ref(0)
            const current_page_update = ref(1)
            const total_pages_update = ref(1)
            const running_sessions_update = ref({})

            async function fetchGithubUpdater(page) {
                const params = new URLSearchParams({
                    page
                })

                const res = await fetch('/rule/history_github_updater/list?' + params.toString())
                const data = await res.json()

                if (res.status === 200) {
                    history_list_update.value = data.history || []
                    total_history_update.value = data.total_history || 0
                    total_pages_update.value = data.total_pages || 1
                    current_page_update.value = page
                } else {
                    history_list_update.value = []
                    total_history_update.value = 0
                    total_pages_update.value = 1
                }
            }

            fetchGithubUpdater(1)

            const visiblePagesUpdate = computed(() => {
                const pages = []
                const total = total_pages_update.value
                const current = current_page_update.value
                if (total <= 7) {
                    for (let i = 1; i <= total; i++) pages.push(i)
                } else {
                    if (current <= 4) {
                        pages.push(1, 2, 3, 4, 5, '...', total)
                    } else if (current >= total - 3) {
                        pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
                    } else {
                        pages.push(1, '...', current - 1, current, current + 1, '...', total)
                    }
                }
                return pages
            })

            async function deleteUpdateHistory(uuid, index) {
                const params = new URLSearchParams({
                    uuid
                })


                const res = await fetch('/rule/history_github_updater/delete?' + params.toString())
                const data = await res.json()
                if (res.status == 200) {
                    var myModalEl = document.getElementById('delete_update_modal_' + uuid);
                    var modal = bootstrap.Modal.getInstance(myModalEl)
                    modal.hide();
                    fetchGithubUpdater(current_page_update.value)
                    fetchSessionRunning()
                }
                create_message(data.message, data.toast_class)
            }

            function goto(history_uuid) {
                window.location.href = `/rule/import_loading/${history_uuid}`
            }
            function gotoUpdate(history_uuid) {
                window.location.href = `/rule/update_loading/${history_uuid}`
            }

            return {
                message_list,
                history_list,
                total_history,
                total_pages,
                current_page,
                visiblePages,
                running_sessions,
                fetchGithubImporter,
                deleteImportHistory,

                history_list_update,
                total_history_update,
                current_page_update,
                total_pages_update,
                running_sessions_update,
                visiblePagesUpdate,
                fetchGithubUpdater,
                deleteUpdateHistory,

                goto,
                gotoUpdate
            }
        }
    }).mount('#main-container')
</script>
{% endblock %}