{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-4" id="main-container">
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-outline-primary float-end position-relative" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
        Running
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" v-cloak>
            [[running_sessions.length]]
            <span class="visually-hidden">unread messages</span>
        </span>
    </button>

    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Running sessions</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <tbody>
                                <tr v-for="(running, index) in running_sessions" :key="index" @click="goto(running.uuid)" style="cursor: pointer;">
                                    <td class="text-center">[[ index + 1 ]]</td>
                                    <td>[[ running.info.repo_url ]]</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <h2 class="fw-bold mb-1 text-center text-primary">GitHub Importer history</h2>
    <div class="mx-auto mb-4" style="width: 60px; height: 4px; background-color: #0d6efd; border-radius: 2px;"></div>
    <p class="text-muted mt-2">
        Browse through your previous GitHub importer sessions and revisit any session by clicking on it.
    </p>
    <template v-if="history_list.length === 0">
        <div class="alert alert-info text-center" role="alert">
            No history found.
        </div>
    </template>
    

    <!-- Table -->
    <template v-if="history_list.length > 0">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col" class="text-center">#</th>
                        <th scope="col">GitHub Importer</th>
                        <th scope="col">Imported</th>
                        <th scope="col">Bad rules</th>
                        <th scope="col">Skipped</th>
                        <th scope="col">Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(history, index) in history_list" :key="index" @click="goto(history.uuid)" style="cursor: pointer;">
                        <td class="text-center">[[ index + 1 ]]</td>
                        <td>[[ history.info.repo_url ]]</td>
                        <td>[[ history.imported ]]</td>
                        <td>[[ history.bad_rules ]]</td>
                        <td>[[ history.skipped ]]</td>
                        <td>[[ history.query_date ]]</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>


    <!-- Pagination -->
    <nav v-if="total_pages > 1" aria-label="GitHub pagination">
        <ul class="pagination justify-content-center">
            <li class="page-item" :class="{ disabled: current_page === 1 }">
                <button class="page-link" @click="fetchGithubImporter(current_page - 1)"
                    :disabled="current_page === 1">Previous</button>
            </li>

            <li v-for="page in visiblePages" :key="page" class="page-item"
                :class="{ active: page === current_page, disabled: page === '...' }">
                <button class="page-link" v-if="page !== '...'" @click="fetchGithubImporter(page)">[[ page ]]</button>
                <span class="page-link" v-else>...</span>
            </li>

            <li class="page-item" :class="{ disabled: current_page === total_pages }">
                <button class="page-link" @click="fetchGithubImporter(current_page + 1)"
                    :disabled="current_page === total_pages">Next</button>
            </li>
        </ul>
    </nav>

    <p class="text-center mt-3 text-muted">Total history found: [[ total_history ]]</p>
</div>
{% endblock %}


{% block script %}
<script type="module">
    const { createApp, ref, computed } = Vue
    import { message_list } from '/static/js/toaster.js'

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const history_list = ref([])
            const total_history = ref(0)
            const current_page = ref(1)
            const total_pages = ref(1)
            const running_sessions = ref({})

            async function fetchGithubImporter(page) {
                const params = new URLSearchParams({
                    page
                })

                const res = await fetch('/rule/history_github_importer/list?' + params.toString())
                const data = await res.json()

                if (res.status === 200) {
                    history_list.value = data.history || []
                    total_history.value = data.total_history || 0
                    total_pages.value = data.total_pages || 1
                    current_page.value = page
                } else {
                    history_list.value = []
                    total_history.value = 0
                    total_pages.value = 1
                }
            }

            fetchGithubImporter(1)

            async function fetchSessionRunning() {
                const res = await fetch('/rule/import_get_session_running')
                
                if (await res.status === 200) {
                    const data = await res.json()
                    running_sessions.value = data
                } else {
                    display_toast(res)
                }
            }
            fetchSessionRunning()

            const visiblePages = computed(() => {
                const pages = []
                const total = total_pages.value
                const current = current_page.value
                if (total <= 7) {
                    for (let i = 1; i <= total; i++) pages.push(i)
                } else {
                    if (current <= 4) {
                        pages.push(1, 2, 3, 4, 5, '...', total)
                    } else if (current >= total - 3) {
                        pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
                    } else {
                        pages.push(1, '...', current - 1, current, current + 1, '...', total)
                    }
                }
                return pages
            })

            function goto(history_uuid) {
                window.location.href = `/rule/import_loading/${history_uuid}`
            }

            return {
                message_list,
                history_list,
                total_history,
                total_pages,
                current_page,
                visiblePages,
                running_sessions,
                fetchGithubImporter,
                goto
            }
        }
    }).mount('#main-container')
</script>
{% endblock %}