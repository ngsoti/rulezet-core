{% extends 'base.html' %}

{% block content %}
<div class="container mt-4" id="main-container">
    <div v-if="rules_list_history">
        <template v-if="rules_list_history.length > 0">
            <h2 class="mb-4"><i class="fas fa-history"></i> Rule Change History</h2>

            <div class="accordion" id="historyAccordion">
                <div v-for="(entry, index) in rules_list_history" :key="index" class="accordion-item mb-3 shadow-sm">
                    <h2 class="accordion-header" :id="'heading-' + index">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            :data-bs-target="'#collapse-' + index" aria-expanded="false"
                            :aria-controls="'collapse-' + index" @click="loadDiff(entry)">
                            [[ entry.rule_title ]] â€” [[ entry.analyzed_at ]]
                            <span class="badge bg-success ms-2" v-if="entry.success">Success</span>
                            <span class="badge bg-danger ms-2" v-else>Failure</span>
                        </button>
                    </h2>

                    <div :id="'collapse-' + index" class="accordion-collapse collapse"
                        :aria-labelledby="'heading-' + index" data-bs-parent="#historyAccordion">
                        <div class="accordion-body">
                            <p><strong>Message:</strong> [[ entry.message ]]</p>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <!-- Conteneur du diff -->
                                    <div id="myDiffElement"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <nav>
                <ul class="pagination justify-content-center">
                    <li class="page-item" :class="{ disabled: current_page === 1 }">
                        <a class="page-link" href="#" @click.prevent="fetchRules(current_page - 1)">Previous</a>
                    </li>
                    <li class="page-item disabled">
                        <a class="page-link" href="#">Page [[ current_page ]] of [[ total_pages ]]</a>
                    </li>
                    <li class="page-item" :class="{ disabled: current_page === total_pages }">
                        <a class="page-link" href="#" @click.prevent="fetchRules(current_page + 1)">Next</a>
                    </li>
                </ul>
            </nav>

        </template>
        <template v-else>
            <div class="text-center my-5">
                <i class="fas fa-folder-open fa-4x text-secondary mb-3"></i>
                <h4 class="text-muted">No history found for this rule</h4>
                <p class="text-muted">It seems there are no accepted updates for this rule yet.</p>
            </div>
        </template>
    </div>
</div>
{% endblock %}

{% block script %}
<script type="module">
    const { createApp, ref, computed, nextTick } = Vue;
    import { renderDiff } from "/static/js/diff_macro.js";


    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const rule_id = "{{ rule_id }}";
            const rules_list_history = ref([]);
            const current_page = ref(1);
            const total_pages = ref(1);

            const proposal = ref(null);

            async function fetchRules(page) {
                const params = new URLSearchParams({ page, rule_id });
                const res = await fetch('/rule/get_rules_page_history_?' + params.toString());

                if (res.status === 200) {
                    const data = await res.json();
                    rules_list_history.value = data.rule.map(entry => ({
                        ...entry,
                        show_diff: true
                    }));
                    total_pages.value = data.total_pages;
                    current_page.value = page;
                }
            }

            fetchRules(1);


            async function loadDiff(entry) {
                proposal.value = entry;

                if (proposal.value) {
                    await nextTick(() => {
                        renderDiff(
                            proposal.value.old_content,
                            proposal.value.new_content,
                            "myDiffElement",
                            "twoText"
                        );
                    });
                }
            }

            return {
                rules_list_history,
                current_page,
                total_pages,
                fetchRules,
                loadDiff,
                proposal
            }
        }
    }).mount('#main-container');
</script>
{% endblock %}