{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-4" id="main-container">
    <h2 class="mb-4 text-center">Rule Change Proposals</h2>

    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#pending" role="tab">To manage</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#history" role="tab">History</a>
        </li>
    </ul>

    <div class="tab-content mt-4">
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="row">
                <template v-if="rules_pendings_list && rules_pendings_list.length > 0">
                    <div class="col-md-12" v-for="(rule , index) in rules_pendings_list" :key="rule.id">
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Rule ID [[ rule.rule_id ]]</h5>
                                <p class="card-text mb-2">
                                    <strong>Status:</strong>
                                    <span :class="{
                                        'badge bg-secondary': rule.status === 'pending',
                                        'badge bg-success': rule.status === 'accepted',
                                        'badge bg-danger': rule.status === 'rejected'
                                    }">
                                        [[ rule.status ]]
                                    </span>
                                </p>
                            
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="card-text">
                                            <strong>Proposed Content:</strong>
                                            <div class="bg-light p-3 rounded border" style="white-space: pre-wrap; font-family: monospace;">
                                                <div v-for="(line, index) in getProposedContentLines(rule.proposed_content)" :key="index">
                                                    <span v-if="line.trim() !== ''" :class="{
                                                        'text-success': isLineNew(line, rule.old_content),
                                                        'text-warning': isLineIdentical(line, rule.old_content)
                                                    }" class="d-block p-2">
                                                        [[ line ]]
                                                    </span>
                                                </div>
                                            </div>
                                        </p>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <p class="card-text">
                                            <strong>Old Content:</strong>
                                            <div class="bg-light p-3 rounded border" style="white-space: pre-wrap; font-family: monospace;">
                                                <div v-for="(line, index) in getOldContentLines(rule.old_content)" :key="index">
                                                    <span v-if="line.trim() !== ''" :class="{
                                                        'text-danger': isLineDeleted(line, rule.proposed_content),
                                                        'text-warning': isLineIdentical(line, rule.proposed_content)
                                                    }" class="d-block p-2">
                                                        [[ line ]]
                                                    </span>
                                                </div>
                                            </div>
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-success btn-sm"
                                            @click="handleDecision(rule.id, 'accepted', rule.rule_id, index)">
                                        Accept
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm"
                                            @click="handleDecision(rule.id, 'rejected', rule.rule_id, index)">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <template v-else>
                    <div class="text-center mt-5">
                        <p class="text-muted">No proposed edits found.</p>
                    </div>
                </template>
            </div>
        </div>

        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="row">
                <template v-if="rules_list && rules_list.length > 0">
                    <div class="col-md-12" v-for="rule in rules_list" :key="rule.id">
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Rule ID [[ rule.rule_id ]]</h5>
                                <p class="card-text mb-2">
                                    <strong>Status:</strong>
                                    <span :class="{
                                        'badge bg-secondary': rule.status === 'pending',
                                        'badge bg-success': rule.status === 'accepted',
                                        'badge bg-danger': rule.status === 'rejected'
                                    }">
                                        [[ rule.status ]]
                                    </span>
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="card-text">
                                            <strong>Proposed Content:</strong>
                                            <div class="bg-light p-3 rounded border" style="white-space: pre-wrap; font-family: monospace;">
                                                <div v-for="(line, index) in getProposedContentLines(rule.proposed_content)" :key="index">
                                                    <span v-if="line.trim() !== ''" :class="{
                                                        'text-success': isLineNew(line, rule.old_content),
                                                        'text-warning': isLineIdentical(line, rule.old_content)
                                                    }" class="d-block p-2">
                                                        [[ line ]]
                                                    </span>
                                                </div>
                                            </div>
                                        </p>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <p class="card-text">
                                            <strong>Old Content:</strong>
                                            <div class="bg-light p-3 rounded border" style="white-space: pre-wrap; font-family: monospace;">
                                                <div v-for="(line, index) in getOldContentLines(rule.old_content)" :key="index">
                                                    <span v-if="line.trim() !== ''" :class="{
                                                        'text-danger': isLineDeleted(line, rule.proposed_content),
                                                        'text-warning': isLineIdentical(line, rule.proposed_content)
                                                    }" class="d-block p-2">
                                                        [[ line ]]
                                                    </span>
                                                </div>
                                            </div>
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-success btn-sm"
                                            @click="handleDecision(rule.id, 'accepted', rule.rule_id, index)">
                                        Accept
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm"
                                            @click="handleDecision(rule.id, 'rejected', rule.rule_id, index)">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </template>
                <template v-else>
                    <div class="text-center mt-5">
                        <p class="text-muted">No decisions found.</p>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script type="module">
    const { createApp, ref } = Vue;
    import { message_list } from '/static/js/toaster.js';

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const csrf_token = '{{ csrf_token() }}';
            const rules_list = ref([]);
            const rules_pendings_list = ref([]);
            const current_page = ref(1);
            const total_pages = ref(1);

            async function fetchRules(page) {
                const res = await fetch('/rule/get_rules_propose_edit_page?page=' + page);
                const data = await res.json();
                rules_list.value = data.rules_list;
                rules_pendings_list.value = data.rules_pendings_list;
                total_pages.value = data.total_pages;
                current_page.value = page;
            }

            async function handleDecision(ruleProposalId, decision, ruleId , index) {
                const res = await fetch(`/rule/validate_proposal?ruleId=${ruleId}&decision=${decision}&ruleproposalId=${ruleProposalId}`);

                if (res.ok) {
                    const result = await res.json();
                    rules_pendings_list.value.splice(index, 1);
                } 
            }

            function getOldContentLines(content) {
                return content.split('\n');
            }

            function getProposedContentLines(content) {
                return content.split('\n');
            }

            function isLineNew(line, oldContent) {
                const normalizedLine = line.trim();
                const normalizedOldContent = oldContent.split('\n').map(l => l.trim());
                
                return !normalizedOldContent.includes(normalizedLine); 
            }

            function isLineDeleted(line, proposedContent) {
                const normalizedLine = line.trim();
                const normalizedProposedContent = proposedContent.split('\n').map(l => l.trim());
                
                return !normalizedProposedContent.includes(normalizedLine);  
            }
            // in yallow if the line is almost identical
            function isLineJustModifie(line, content) {
                const normalizedLine = line.trim();
                const normalizedContent = content.split('\n').map(l => l.trim());
                
                return normalizedProposedContent.includes(normalizedLine);  
            }


            // shoud be remove 
            function isLineIdentical(line, content) {
                const normalizedLine = line.trim();
                const normalizedContent = content.split('\n').map(l => l.trim());
                
                return normalizedContent.includes(normalizedLine);  
            }



            fetchRules(1);

            return {
                csrf_token,
                rules_list,
                fetchRules,
                current_page,
                total_pages,
                handleDecision,
                rules_pendings_list,
                getOldContentLines,
                getProposedContentLines,
                isLineNew,
                isLineDeleted,
                isLineIdentical
            };
        }
    }).mount('#main-container');
</script>
{% endblock %}
