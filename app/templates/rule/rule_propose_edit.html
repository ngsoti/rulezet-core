{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-4" id="main-container">
    <h2 class="mb-4 text-center">Rule Change Proposals</h2>

    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#pending" role="tab">To manage</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#history" role="tab">History</a>
        </li>
    </ul>

    <div class="tab-content mt-4">
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="row">
                <template v-if="rules_pendings_list && rules_pendings_list.length > 0">
                    <div class="col-md-12" v-for="(rule , index) in rules_pendings_list" :key="rule.id">
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Rule ID [[ rule.rule_id ]]</h5>
                                <p class="card-text mb-2">
                                    <strong>Status:</strong>
                                    <span :class="{
                                        'badge bg-secondary': rule.status === 'pending',
                                        'badge bg-success': rule.status === 'accepted',
                                        'badge bg-danger': rule.status === 'rejected'
                                    }">
                                        [[ rule.status ]]
                                    </span>
                                </p>
                                <p class="card-text">
                                    <strong>Proposed Content:</strong>
                                    <pre class="bg-light p-3 rounded border" style="white-space: pre-wrap; font-family: monospace;">[[ rule.proposed_content ]]</pre>
                                </p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-success btn-sm"
                                            @click="handleDecision(rule.id, 'accepted', rule.rule_id, index)">
                                        Accept
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm"
                                            @click="handleDecision(rule.id, 'rejected', rule.rule_id, index)">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <template v-else>
                    <div class="text-center mt-5">
                        <p class="text-muted">No proposed edits found.</p>
                    </div>
                </template>
            </div>
        </div>

        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="row">
                <template v-if="rules_list && rules_list.length > 0">
                    <div class="col-md-12" v-for="rule in rules_list" :key="rule.id">
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Rule ID [[ rule.rule_id ]]</h5>
                                <p class="card-text mb-2">
                                    <strong>Status:</strong>
                                    <span :class="{
                                        'badge bg-success': rule.status === 'accepted',
                                        'badge bg-danger': rule.status === 'rejected'
                                    }">
                                        [[ rule.status ]]
                                    </span>
                                </p>
                                <p class="card-text">
                                    <strong>Proposed Content:</strong>
                                    <pre class="bg-light p-3 rounded border" style="white-space: pre-wrap; font-family: monospace;">[[ rule.proposed_content ]]</pre>
                                </p>
                                <p class="card-text">
                                    <strong>Date:</strong> [[ new Date(rule.timestamp).toLocaleString() ]]
                                </p>
                            </div>
                        </div>
                    </div>
                </template>
                <template v-else>
                    <div class="text-center mt-5">
                        <p class="text-muted">No decisions found.</p>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script type="module">
    const { createApp, ref } = Vue;
    import { message_list } from '/static/js/toaster.js';

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const csrf_token = '{{ csrf_token() }}';
            const rules_list = ref([]);
            const rules_pendings_list = ref([]);
            const current_page = ref(1);
            const total_pages = ref(1);

            async function fetchRules(page) {
                const res = await fetch('/rule/get_rules_propose_edit_page?page=' + page);
                const data = await res.json();
                rules_list.value = data.rules_list;
                rules_pendings_list.value = data.rules_pendings_list;
                total_pages.value = data.total_pages;
                current_page.value = page;
            }

            async function handleDecision(ruleProposalId, decision, ruleId , index) {
            const res = await fetch(`/rule/validate_proposal?ruleId=${ruleId}&decision=${decision}&ruleproposalId=${ruleProposalId}`);

            if (res.ok) {
                const result = await res.json();
                rules_pendings_list.value.splice(index, 1);
                // fetchRules(current_page.value);  
            } 
        }



            fetchRules(1);

            return {
                csrf_token,
                rules_list,
                fetchRules,
                current_page,
                total_pages,
                handleDecision,
                rules_pendings_list
            };
        }
    }).mount('#main-container');
</script>

{% endblock %}