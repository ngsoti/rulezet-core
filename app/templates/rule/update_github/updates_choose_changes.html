{% extends 'base.html' %}

{% block content %}
<!-- Interface to verify if there is an update in a GitHub project -->
<div class="container mt-5" id="main-container">
    <div v-if="owner_rule" class="mb-4">
        <div class="mb-4 border-bottom pb-3">
            <h2 class="mb-3 text-center text-primary fw-bold">
                [[ owner_rule.rule_title ]] Update
                <div class="mx-auto" style="width: 60px; height: 4px; background-color: #0d6efd; border-radius: 2px;">
                </div>
            </h2>
            <p class="text-muted mt-2 text-center">
                Use the tabs below to check for updates to your rules from GitHub sources. You can search by GitHub URLs
                or
                by individual rules to ensure you have the latest versions.
            </p>
        </div>
        <div class="card shadow-lg border-0">




            <div class="card-body">
                <ul class="list-group mb-4">
                    <li class="list-group-item"><strong>Analyzed By: </strong>
                        <a :href="`/account/detail_user/${owner_rule.analyzed_by_user_id}`" class="stretched-link"></a>
                        <span class="badge text-bg-secondary ">[[
                            owner_rule.analyzed_by_user_name ]]
                        </span></a>

                    </li>
                    <li class="list-group-item"><strong>Format:</strong> <span class="badge text-bg-primary ">[[
                            owner_rule.rule_format ]] </span></li>
                    <li class="list-group-item"><strong>Analyzed At:</strong> [[ owner_rule.analyzed_at ]]</li>
                    <li class="list-group-item text-success" v-if="owner_rule.success">
                        <i class="fas fa-check-circle me-2"></i> Update found
                    </li>
                    <li class="list-group-item text-danger" v-else>
                        <i class="fas fa-times-circle me-2"></i> Update Failed
                    </li>
                    <li class="list-group-item"><strong>Statue:</strong>
                        <span :class="['badge ms-1', owner_rule.message === 'rejected' ? 'bg-danger' : 'bg-success']">
                            [[ owner_rule.message ]]
                        </span>
                    </li>
                </ul>

                <div class="row mt-4">
                    <div class="row mt-4">
                        <div id="myDiffElement"></div>
                    </div>
                </div>
            </div>
            <template v-if="owner_rule.message != 'rejected'">
                <div class="d-flex justify-content-center gap-3 mt-4 mb-3">
                    <!-- Accept Button -->
                    <a :href="`/rule/update_github_rule?rule_id=${rule_id}&decision=accepted`"
                        class="btn btn-success btn-sm d-inline-flex align-items-center shadow-sm px-3 py-2 rounded-pill">
                        <i class="fas fa-check me-2"></i> Accept
                    </a>

                    <!-- Reject Button -->
                    <a :href="`/rule/update_github_rule?rule_id=${rule_id}&decision=rejected`"
                        class="btn btn-danger btn-sm d-inline-flex align-items-center shadow-sm px-3 py-2 rounded-pill">
                        <i class="fas fa-times me-2"></i> Reject
                    </a>
                </div>
            </template>
            <template v-else>
                <div class="d-flex justify-content-center gap-3 mt-4 mb-3">
                    <span>
                        This update has been
                        <span class="badge bg-danger">[[ owner_rule.message ]]</span>
                    </span>
            </template>
            <!-- Go back Button -->
            <div class="d-flex justify-content-center gap-3 mt-4 mb-3">
                <a href="javascript:history.back()" style="width: auto;"
                    class="btn btn-secondary btn-sm d-inline-flex align-items-center shadow-sm px-3 py-2 rounded-pill">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back
                </a>
            </div>




        </div>
    </div>


    <div v-else class="text-center text-muted mt-5">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p class="mt-3">Loading rule history...</p>
    </div>
</div>
{% endblock %}

{% block script %}
<script type="module">
    const { createApp, ref, nextTick } = Vue
    import { message_list } from '/static/js/toaster.js'
    import { renderDiff } from "/static/js/diff_macro.js";

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const owner_rule = ref(null)
            const rule_id = "{{ history_id }}"

            async function fetchRules() {
                const params = new URLSearchParams({ rule_id: rule_id })
                const res = await fetch('/rule/get_history_rule?' + params.toString())

                if (res.status === 200) {
                    const data = await res.json()
                    owner_rule.value = data.history_rule

                    if (owner_rule.value) {
                        await nextTick(() => {
                            renderDiff(
                                owner_rule.value.old_content,
                                owner_rule.value.new_content,
                                "myDiffElement",
                                "twoText"
                            );
                        });
                    }
                } else {
                    message_list(["Failed to load rule history."], "error")
                }
            }
            fetchRules()

            return {
                owner_rule,
                rule_id,
            }
        }
    }).mount('#main-container')
</script>
{% endblock %}