{% extends 'base.html' %}
{% block content %}

<!-- Interface to verify if there is an update in a github project -->

<div class="container mt-4" id="main-container" >
    <div class="card bg-white shadow-sm border-0 mb-4">
            <div class="card-body">
                <h5 class="card-title text-secondary mb-3">üîç Smart Filters</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                    <input type="text" v-model="searchQuery" @input="onSearchInput" @keyup.enter="onEnterKey" class="form-control form-control-sm rounded-pill" placeholder="Search by keywords...">
                    </div>
                    <div class="col-md-3">
                        <select v-model="ruleType" class="form-select form-select-sm rounded-pill">
                            <option value="">All Types</option>
                            <option value="yara">YARA</option>
                            <option value="sigma">SIGMA</option>
                            <option value="zeek">Zeek</option>
                            <option value="suricata">Suricata</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select v-model="sourceFilter" class="form-select form-select-sm rounded-pill">
                            <option value="">All Sources</option>
                            <option v-for="source in userSources" :key="source" :value="source">
                                [[ source ]]
                            </option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <button class="btn btn-dark w-100 rounded-pill" @click="fetchRules(1)">
                            <i class="fas fa-sliders-h"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>



    <div class="table-responsive">
        <div v-if="owner_rules.length > 0">
            <table class="table table-striped table-hover align-middle" >
                <thead class="table-dark">
                    <tr>
                    <th scope="col">
                        <input type="checkbox" @change="toggleAll" :checked="allSelected" aria-label="Select all" />
                    </th>
                    <th scope="col"><i class="fas fa-hashtag"></i> ID</th>
                    <th scope="col"><i class="fas fa-shield-alt"></i> Title</th>
                    <th scope="col"><i class="fas fa-user"></i> Author</th>
                    <th scope="col"><i class="fas fa-calendar-alt"></i> Created</th>
                    <th scope="col"><i class="fas fa-link"></i> Source</th>
                    <th scope="col"><i class="fas fa-tools"></i> Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="rule in owner_rules" :key="rule.id" 
                        @click="toggleSelection(rule.id)" 
                        :class="{ 'table-primary': selectedRules.includes(rule.id) }"
                        style="cursor: pointer;">
                    <td @click.stop>
                        <input type="checkbox" :checked="selectedRules.includes(rule.id)" />
                    </td>
                    <td>[[ rule.id ]]</td>
                    <td>[[ rule.title ]]</td>
                    <td>[[ rule.author ]]</td>
                    <td>[[ rule.creation_date ]]</td>
                    <td>
                        <a :href="rule.source" target="_blank" class="text-decoration-none">
                        GitHub <i class="fas fa-external-link-alt"></i>
                        </a>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" @click.stop="checkUpdate(rule.id)">
                        <i class="fas fa-sync-alt"></i> Check Update
                        </button>
                    </td>
                    </tr>
                </tbody>
            </table>
            <div class="d-flex justify-content-center mt-3">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                    <li class="page-item" :class="{ disabled: owner_current_page === 1 }">
                        <a class="page-link" href="#" @click.prevent="fetchRules(owner_current_page - 1)">
                        <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li class="page-item" v-for="page in visiblePages" :key="page" :class="{ active: owner_current_page === page, disabled: page === '...' }">
                        <a v-if="page !== '...'" class="page-link" href="#" @click.prevent="fetchRules(page)">[[ page ]]</a>
                        <span v-else class="page-link">...</span>
                    </li>
                    <li class="page-item" :class="{ disabled: owner_current_page === owner_total_page }">
                        <a class="page-link" href="#" @click.prevent="fetchRules(current_page + 1)">
                        Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
                    </ul>
                </nav>
            </div>
        </div>
        <template v-else>
            No rule
        </template>
    </div>
</div>




{% endblock %}
{% block script %}
<script type="module">
    const { createApp, ref, computed } = Vue
    import { message_list } from '/static/js/toaster.js'

    createApp({
        delimiters: ['[[', ']]'],
        setup() {
            /**
             *          ########################
             *          #   Main Rule State   #
             *          ########################
             */
            const owner_rules = ref([])              // Rules shown on current page
            const owner_current_page = ref(1)        // Current pagination page
            const owner_total_page = ref(0)          // Total number of pages

            const selectedRules = ref([])            // IDs of selected rules
            const allRuleIds = ref([])               // All rule IDs of current user


            const searchQuery = ref('');
            const sourceFilter = ref('');
            const ruleType = ref('');
            const userSources = ref([]);  

            /**
             *          #######################
             *          #   Fetch one page    #
             *          #######################
             */
            async function fetchRules(page) {
                const params = new URLSearchParams({
                    page,
                    search: searchQuery.value,
                    rule_type: ruleType.value,
                    source: sourceFilter.value
                });

                const res = await fetch('/rule/get_my_rules_page_filter?' + params.toString());
                if (res.status === 200) {
                    const data = await res.json();
                    owner_rules.value = data.rule;
                    owner_current_page.value = page;
                    owner_total_page.value = data.total_pages;
                }
            }

            fetchRules(1) // Initial fetch on mount

            /**
             *          ##########################
             *          #   Fetch all rule IDs   #
             *          ##########################
             */
            async function fetchAllOwnerRules() {
                const res = await fetch('/rule/get_all_rules_owner');
                if (res.status === 200) {
                    const data = await res.json();
                    return data.map(rule => rule.id); // Return only the IDs
                } else {
                    message_list.error("Error while fetching all rules.");
                    return [];
                }
            }

            async function fetchUserSources() {
                const res = await fetch('/rule/get_all_sources_owner');
                if (res.ok) {
                    const data = await res.json();
                    return data;
                } else {
                    message_list.error("Failed to fetch sources.");
                    return [];
                }
            }

            fetchUserSources()

            /**
             *          ########################
             *          #   Selection logic   #
             *          ########################
             */
            function isSelected(id) {
                return selectedRules.value.includes(id)
            }

            function toggleSelection(id) {
                const index = selectedRules.value.indexOf(id)
                if (index === -1) {
                    selectedRules.value.push(id)
                } else {
                    selectedRules.value.splice(index, 1)
                }
            }

            // Triggered by the master checkbox ‚Äî selects or deselects all rules
            async function toggleAll() {
                if (selectedRules.value.length === allRuleIds.value.length && allRuleIds.value.length > 0) {
                    selectedRules.value = [] // Unselect all
                } else {
                    allRuleIds.value = await fetchAllOwnerRules()
                    selectedRules.value = [...allRuleIds.value] // Select all
                }
            }

            const allSelected = computed(() => {
                return (
                    allRuleIds.value.length > 0 &&
                    selectedRules.value.length === allRuleIds.value.length
                )
            })

            /**
             *          ############
             *          #  filter  #
             *          ############
             */

            
            async function onSearchInput() {
                if (searchQuery.value.trim() === "") {
                await fetchRules(1)
                } else {
                await fetchRules(1)
                }
            }

            async function onEnterKey() {
                await fetchRules(1)
            }

            async function fetchUserSources() {
                const res = await fetch('/rule/get_all_sources_owner');
                if (res.ok) {
                    const data = await res.json();
                    userSources.value = data;
                } else {
                    message_list.error("Failed to fetch sources.");
                }
            }

            fetchUserSources();


            /**
             *          ##########################
             *          #   Check GitHub Update  #
             *          ##########################
             */
            function checkUpdate(id) {
                alert(`Checking updates for rule ID ${id}`)
            }

            /**
             *          #######################
             *          #   Pagination logic #
             *          #######################
             */
            const visiblePages = computed(() => {
                const pages = []
                const total = owner_total_page.value
                const current = owner_current_page.value
                if (total <= 7) {
                    for (let i = 1; i <= total; i++) pages.push(i)
                } else {
                    if (current <= 4) {
                        pages.push(1, 2, 3, 4, 5, '...', total)
                    } else if (current >= total - 3) {
                        pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
                    } else {
                        pages.push(1, '...', current - 1, current, current + 1, '...', total)
                    }
                }
                return pages
            })

            return {
                owner_rules,
                selectedRules,
                allRuleIds,
                owner_current_page,
                owner_total_page,
                fetchRules,
                toggleSelection,
                toggleAll,
                allSelected,
                checkUpdate,
                visiblePages,
                searchQuery,
                sourceFilter,
                ruleType,
                userSources,
                onSearchInput,
                onEnterKey
            }

        }
    }).mount('#main-container')
</script>
{% endblock %}
