{% extends 'base.html' %}
{% block content %}

<!-- Interface to verify if there is an update in a github project -->

<div class="container mt-4" id="main-container" >
    <ul class="nav nav-tabs fw-bold text-uppercase shadow-sm rounded" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active d-flex align-items-center gap-2" data-bs-toggle="tab" data-bs-target="#manuel" type="button" role="tab">
                <i class="fa-solid fa-gear"></i> By GitHub
            </button>
        </li>
        <!-- <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center gap-2" data-bs-toggle="tab" data-bs-target="#auto" type="button" role="tab">
                <i class="fa-solid fa-layer-group"></i> By Rule
            </button>
        </li> -->
        <!-- <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center gap-2" data-bs-toggle="tab" data-bs-target="#auto" type="button" role="tab">
                <i class="fa-solid fa-layer-group"></i> Auto update
            </button>
        </li> -->
    </ul>

    <div class="tab-content  p-4 border border-top-0 shadow-sm rounded-bottom">
        <!-- Tab 1: By github -->
        <div class="tab-pane fade show active" id="manuel" role="tabpanel">
            <div class="d-flex  mb-3">
                <input v-model="searchQuery" @keyup.enter="fetchUrlGithub(1)" class="form-control " placeholder="Search for GitHub URLs..." @input="onSearchInput">
            </div>
            <p class="text-center mt-3 text-muted">Total URLs found: [[ total_url ]]</p>


            <div v-if="github_url.length > 0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="text-center">Select</th>
                                <th scope="col">GitHub URL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(url, index) in github_url" :key="index"
                                @click="toggleUrl(url)"
                                style="cursor: pointer;">
                                <td class="text-center">
                                    <input type="checkbox" :checked="selected_urls.includes(url)" @change.stop="toggleUrl(url)">
                                </td>
                                <td>[[ url ]]</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <nav v-if="total_pages > 1" aria-label="GitHub pagination">
                <ul class="pagination justify-content-center">
                <li class="page-item" :class="{ disabled: current_page === 1 }">
                    <button class="page-link" @click="fetchUrlGithub(current_page - 1)" :disabled="current_page === 1">Previous</button>
                </li>

                <li v-for="page in visiblePages" :key="page"
                    class="page-item"
                    :class="{ active: page === current_page, disabled: page === '...' }">
                    <button class="page-link" v-if="page !== '...'" @click="fetchUrlGithub(page)">[[ page ]]</button>
                    <span class="page-link" v-else>...</span>
                </li>

                <li class="page-item" :class="{ disabled: current_page === total_pages }">
                    <button class="page-link" @click="fetchUrlGithub(current_page + 1)" :disabled="current_page === total_pages">Next</button>
                </li>
                </ul>
            </nav>

            

            <!-- Selected URLs as tags -->
            <div class="mt-3" v-if="selected_urls.length > 0">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <h6 class="mb-0">Selected GitHub URLs:</h6>
                    <span class="badge bg-secondary">[[ selected_urls.length ]]</span>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    <span v-for="(url, idx) in selected_urls" :key="idx" class="badge bg-primary d-flex align-items-center gap-1">
                        [[ url ]]
                        <button type="button" class="btn-close btn-close-white btn-sm" @click="removeUrl(url)"></button>
                    </span>
                </div>

                <div class="mt-3 d-flex justify-content-center">
                    <button class="btn btn-dark rounded-pill" @click="foundUpdateWithUrl()">
                        <i class="fas fa-sliders-h"></i>
                        Found updates for [[ selected_urls.length ]] GitHub URL(s)
                    </button>
                </div>
            </div>
  
            <div class="mt-4" v-if="updateResults.length > 0">
                <h5>Update Check Results ( [[ updateResults.length]])</h5>
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Rule Title</th>
                            <th>Status</th>
                            <th>Message</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="result in updateResults" :key="result.id">
                            <td>[[ result.title ]]</td>
                            <td>
                                <span v-if="result.success && result.new_content" class="text-success">
                                    <i class="fas fa-info-circle"></i> Up-to-date
                                </span>
                                <span v-else class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i> Failed
                                </span>
                            </td>
                            <td>[[ result.message ]]</td>
                            <td>
                                <a class="btn btn-sm btn-primary" :href="'/rule/update_github/choose_changes?id=' + result.history_id"  > 
                                    <!-- target="_blank" -->
                                    <i class="fas fa-code-branch"></i> Compare Changes
                                </a>

                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-5" v-if="old_choice.length > 0">
                    <div class="card shadow-sm border-0">
                        <div class="card-header  text-white d-flex align-items-center">
                            <i class="fas fa-history me-2" style=" word-break: break-word; color: rgb(10, 88, 202)"></i>
                            <h5 class="mb-0" style=" word-break: break-word; color: rgb(10, 88, 202)">Update Check Results (pending) <span class="badge bg-light text-primary ms-2">[[ old_choice.length ]]</span></h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered mb-0">
                                    <thead class="table-light text-center">
                                        <tr>
                                            <th scope="col"><i class="fas fa-tag me-1"></i> Rule Title</th>
                                            <th scope="col"><i class="fas fa-info-circle me-1"></i> Status</th>
                                            <th scope="col"><i class="fas fa-comment-dots me-1"></i> Message</th>
                                            <th scope="col"><i class="fas fa-code-branch me-1"></i> Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="result in old_choice" :key="result.id">
                                            <td>
                                                <a :href="`/rule/detail_rule/${result.rule_id}`" title="view more about this rule" >
                                                    <i class="fas fa-shield-alt me-2 text-primary"></i> <span class="mb-2" style="max-width: 75%; word-break: break-word; color: rgb(10, 88, 202)">[[ result.rule_title ]]</span>
                                                </a>
                                            </td>
                                            <td class="text-center">
                                                <span v-if="result.success && result.new_content" class="text-success fw-semibold">
                                                    <i class="fas fa-check-circle me-1"></i> Up-to-date
                                                </span>
                                                <span v-else class="text-danger fw-semibold">
                                                    <i class="fas fa-times-circle me-1"></i> Failed
                                                </span>
                                            </td>
                                            <td>[[ result.message ]]</td>
                                            <td class="text-center">
                                                <a class="btn btn-sm btn-outline-primary" :href="'/rule/update_github/choose_changes?id=' + result.id">
                                                    <i class="fas fa-code-branch me-1"></i> Compare
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            
            
        </div>
        <!-- Tab 2: By rule -->
        <div class="tab-pane fade " id="auto" role="tabpanel">

        </div>
        <!-- Tab 3: Auto update -->
        <!-- <div class="tab-pane fade " id="auto" role="tabpanel">

        </div> -->
    </div>
</div>
{% endblock %}
{% block script %}
<script type="module">
    const { createApp, ref, computed } = Vue
    import { message_list , display_prepared_toast , prepare_toast, display_toast} from '/static/js/toaster.js'

    createApp({
        delimiters: ['[[', ']]'],
        setup() {

            //      ##################################################
            //      #   Github urls list with search and pagination  #
            //      ##################################################

            const github_url = ref([])
            const total_url = ref(0)
            const current_page = ref(1)
            const total_pages = ref(1)
            const searchQuery = ref('')

            async function fetchUrlGithub(page) {
                const params = new URLSearchParams({
                    page,
                    search: searchQuery.value || ''
                })

                const res = await fetch('/rule/get_url_github?' + params.toString())
                const data = await res.json()

                if (res.status === 200) {
                    github_url.value = data.github_url || []
                    total_url.value = data.total_url || 0
                    total_pages.value = data.total_pages || 1
                    current_page.value = page
                } else {
                    github_url.value = []
                    total_url.value = 0
                    total_pages.value = 1
                }
            }

            fetchUrlGithub(1)

            const visiblePages = computed(() => {
                const pages = []
                const total = total_pages.value
                const current = current_page.value
                if (total <= 7) {
                    for (let i = 1; i <= total; i++) pages.push(i)
                } else {
                    if (current <= 4) {
                    pages.push(1, 2, 3, 4, 5, '...', total)
                    } else if (current >= total - 3) {
                    pages.push(1, '...', total - 4, total - 3, total - 2, total - 1, total)
                    } else {
                    pages.push(1, '...', current - 1, current, current + 1, '...', total)
                    }
                }
                return pages
            })

            async function onSearchInput() {
                if (searchQuery.value.trim() === "") {
                await fetchUrlGithub(1)
                } else {
                await fetchUrlGithub(1)
                }
            }

            async function onEnterKey() {
                await fetchUrlGithub(1)
            }




            const selected_urls = ref([])
            const csrf_token = '{{ csrf_token() }}';

             // Toggle URL selection
            const toggleUrl = (url) => {
                if (selected_urls.value.includes(url)) {
                    selected_urls.value = selected_urls.value.filter(u => u !== url)
                } else {
                    selected_urls.value.push(url)
                }
            }

            // Remove URL from selection
            const removeUrl = (url) => {
                selected_urls.value = selected_urls.value.filter(u => u !== url)
            }

            async function foundUpdateWithUrl() {
                if (selected_urls.value.length === 0) {
                    display_prepared_toast({
                            message: 'You have to select at least one GitHub URL.',
                            toast_class: 'danger',
                            id: Math.random()
                        });
                     return;
                }
                const response = await fetch("/rule/check_updates_by_url", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrf_token
                    },
                    body: JSON.stringify({ url: selected_urls.value }),
                });   
                let data = null;    
                if (response.status === 200) {
                    data = await response.json();
                    updateResults.value = data.results;

                    if (data.nb_update === 0) {
                        await display_prepared_toast({
                            message: 'No updates found for the selected rules.',
                            toast_class: 'info',
                            id: Math.random()
                        });
                    }else{
                        await display_prepared_toast({
                            message: 'updates found for the selected rules.',
                            toast_class: 'success',
                            id: Math.random()
                        });
                    }
                }

            }

            const updateResults = ref([]);
                
            const old_choice = ref([])             
            const old_current_page = ref(1)        
            const old_total_page = ref(0)         

            async function fetchOldRules(page) {
                const params = new URLSearchParams({
                    page
                });

                const res = await fetch('/rule/get_old_rule_choice?' + params.toString());
                if (res.status === 200) {
                    const data = await res.json();
                    old_choice.value = data.rule;
                    old_current_page.value = page;
                    old_total_page.value = data.total_pages;
                }
            }
            fetchOldRules(1)
            return {
                message_list,
                github_url,
                total_url,
                total_pages,
                current_page,
                searchQuery,
                visiblePages,
                fetchUrlGithub,
                onSearchInput,
                selected_urls,
                toggleUrl,
                removeUrl,
                foundUpdateWithUrl,
                updateResults,
                old_choice,
                fetchOldRules
            }

        }
    }).mount('#main-container')
</script>
{% endblock %}
