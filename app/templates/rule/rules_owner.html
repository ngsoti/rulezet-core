{% extends 'base.html' %}
{% block content %}

<div class="container mt-4 pb-5" id="main-container" v-cloak>

    <div class="mb-5 text-center">
        <h2 class="fw-bold text-primary mb-2">
            <i class="fa-solid fa-user-shield me-2"></i>My Rules
        </h2>
        <div class="mx-auto mb-3" style="width: 50px; height: 4px; background: var(--bs-primary); border-radius: 10px;">
        </div>
        <p class="text-muted mx-auto" style="max-width: 600px;">
            Manage, edit, or delete the security rules you've contributed to the platform.
        </p>
    </div>

    <rule-filter-bar ref="filterBar" :user-id="user_id" :auto-fetch="true" api-endpoint="/rule/get_rules_page_filter"
        :current-user-is-authenticated="'{{current_user.is_authenticated}}'" @update:results="onRulesUpdated"
        @loading="search_is_loading = $event" :csrf-token="'{{ csrf_token() }}'">
    </rule-filter-bar>

    <div v-if="selectedRules.length > 0" class="bulk-action-bar shadow-lg animate slideInUp">
        <div class="d-flex align-items-center justify-content-between bg-danger text-white p-3 rounded-4 mb-4">
            <div class="ms-2">
                <i class="fa-solid fa-circle-check me-2"></i>
                <strong>[[ selectedRules.length ]]</strong> rules selected
            </div>
            <button class="btn btn-light btn-sm fw-bold rounded-pill px-4" @click="deleteSelectedRules">
                <i class="fa-solid fa-trash-can me-2 text-danger"></i>Delete Selected
            </button>
        </div>
    </div>

    <div class="results-wrapper">
        <template v-if="search_is_loading">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="text-muted mt-3">Loading your rules...</p>
            </div>
        </template>

        <template v-else-if="rules_list && rules_list.length > 0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="small text-muted">Showing [[ rules_list.length ]] of [[ total_rules_liste ]] rules</span>
                <pagination-component :current-page="current_page" :total-pages="total_pages"
                    @change-page="changePage"></pagination-component>
            </div>

            <div class="rules-container">
                <div v-for="(rule, index) in rules_list" :key="rule.id"
                    class="rule-card-modern d-flex align-items-start p-3 mb-3" @click="detailRule(rule.id)">

                    <div class="me-3 pt-1" @click.stop>
                        <div class="custom-checkbox">
                            <input type="checkbox" :value="rule.id" v-model="selectedRules" :id="'check-'+rule.id">
                            <label :for="'check-'+rule.id"></label>
                        </div>
                    </div>

                    <div class="flex-grow-1 min-width-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="fw-bold mb-1 rule-title text-truncate">[[ rule.title ]]</h6>
                            <div class="d-flex gap-2" @click.stop>
                                <a :href="'/rule/edit_rule/' + rule.id" class="btn-action edit" title="Edit">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </a>
                                <button class="btn-action delete" @click="confirmDelete(rule)" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                <button class="btn-action favorite" @click="favorite(rule.id)"
                                    :title="rule.is_favorited ? 'Unstar' : 'Star'">
                                    <i class="fa-solid fa-star" :class="{'text-warning': rule.is_favorited}"></i>
                                </button>
                            </div>
                        </div>

                        <p class="rule-description small mb-2 text-truncate-2">[[ rule.description ]]</p>

                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <span class="badge-custom format">[[ rule.format ]]</span>
                            <span class="badge-custom license" v-if="rule.license">[[ rule.license ]]</span>
                            <div @click.stop class="d-inline-block ms-2">
                                <vulnerability-displays-list object-type="rule" :object-id="rule.id" :max-visible="3">
                                </vulnerability-displays-list>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <pagination-component :current-page="current_page" :total-pages="total_pages"
                @change-page="changePage"></pagination-component>
        </template>

        <div v-else class="text-center py-5 rounded-4 bg-light-subtle border border-dashed">
            <i class="fa-solid fa-folder-open fa-3x mb-3 text-muted opacity-50"></i>
            <h5 class="fw-bold">No rules found</h5>
            <p class="text-muted">You haven't created any rules matching these criteria yet.</p>
            <a href="/rule/create_rule" class="btn btn-primary rounded-pill px-4 mt-2">
                <i class="fa-solid fa-plus me-2"></i>Create your first rule
            </a>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center p-4">
                <i class="fa-solid fa-triangle-exclamation text-danger fa-3x mb-3"></i>
                <h5 class="fw-bold">Delete Rule?</h5>
                <p class="text-muted">Are you sure you want to delete <strong>[[ ruleToDelete?.title ]]</strong>? This
                    action is irreversible.</p>
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger rounded-pill px-4" @click="executeDelete">Confirm Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script type="module">
    const { createApp, ref, onMounted } = Vue
    import { create_message, message_list } from '/static/js/toaster.js'
    import VulnerabilityDisplaysList from '/static/js/vulnerability/vulnerabilityDisplayList.js';
    import RuleFilterBar from '/static/js/rule/ruleFilterBar.js';
    import PaginationComponent from '/static/js/rule/paginationComponent.js';

    createApp({
        delimiters: ['[[', ']]'],
        components: {
            'vulnerability-displays-list': VulnerabilityDisplaysList,
            'rule-filter-bar': RuleFilterBar,
            'pagination-component': PaginationComponent
        },
        setup() {
            const csrf_token = '{{ csrf_token() }}';
            const rules_list = ref([]);
            const total_rules_liste = ref(0);
            const current_page = ref(1);
            const total_pages = ref(1);
            const search_is_loading = ref(true);
            const filterBar = ref(null);
            const selectedRules = ref([]);
            const ruleToDelete = ref(null);
            const user_id = parseInt('{{ current_user.id}}');



            const onRulesUpdated = (results) => {
                rules_list.value = results.rules.rule || [];
                total_pages.value = results.total_pages || 1;
                current_page.value = results.current_page || 1;
                total_rules_liste.value = results.total_rules || 0;

                search_is_loading.value = false;
            };

            const changePage = (page) => {
                if (filterBar.value) {
                    filterBar.value.fetchRules(page);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const detailRule = (id) => {
                window.location.href = `/rule/detail_rule/${id}`;
            };

            const confirmDelete = (rule) => {
                ruleToDelete.value = rule;
                const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                modal.show();
            };

            const executeDelete = async () => {
                const res = await fetch(`/rule/delete_rule?id=${ruleToDelete.value.id}`);
                if (res.ok) {
                    rules_list.value = rules_list.value.filter(r => r.id !== ruleToDelete.value.id);
                    create_message("Rule deleted successfully", "success");
                    bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                }
            };

            const deleteSelectedRules = async () => {
                if (!confirm(`Delete ${selectedRules.value.length} rules?`)) return;

                const res = await fetch('/rule/delete_rule_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf_token },
                    body: JSON.stringify({ ids: selectedRules.value })
                });
                const data = await res.json();
                if (data.success) {
                    selectedRules.value = [];
                    filterBar.value.fetchRules(current_page.value);
                }
                create_message(data.message, data.toast_class);
            };

            const favorite = async (rule_id) => {
                const res = await fetch(`/rule/favorite/${rule_id}`);
                const data = await res.json();
                if (res.ok) {
                    const rule = rules_list.value.find(r => r.id === rule_id);
                    if (rule) rule.is_favorited = data.is_favorited;
                }
                create_message(data.message, data.toast_class);
            };

            return {
                rules_list, total_rules_liste, current_page, total_pages,
                search_is_loading, filterBar, selectedRules, ruleToDelete,
                onRulesUpdated, changePage, detailRule, confirmDelete,
                executeDelete, deleteSelectedRules, favorite, message_list,
                user_id, search_is_loading

            }
        }
    }).mount('#main-container')
</script>
{% endblock %}