{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-4">
    <h3 class="text-center mb-4">Edit a Rule</h3>
    <form action="" method="post">
        {{ form.hidden_tag() }}
        
        <div class="modal-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form.title.label(class_="col-form-label") }}
                        {{ form.title(class_="form-control",
                                    placeholder="Enter the rule title...",
                                    title="This is the title of your rule (e.g. SQL Injection Detection)") }}
                        {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.title.errors[0] | safe }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form.format.label(class_="col-form-label") }}
                        {{ form.format(class_="form-select",
                                    placeholder="Choose a rule format...",
                                    title="Format of the rule") }}
                        {% if form.format.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.format.errors[0] | safe }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="form-group">
                    {{ form.license.label(class_="col-form-label") }}
                    {{ form.license(class_="form-control", id="license-select",
                                    placeholder="Choose a license...",
                                    title="License for the visibility of the rule") }}
                    {% if form.license.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.license.errors[0] | safe }}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                <div class="form-group">
                    {{ form.source.label(class_="col-form-label") }}
                    {{ form.source(class_="form-control",
                                    placeholder="Enter the rule source...",
                                    title="Source to find the rule in the net") }}
                    {% if form.source.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.source.errors[0] | safe }}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form.version.label(class_="col-form-label") }}
                        {{ form.version(class_="form-control",
                                    placeholder="Enter the rule version (1.0 or 1)...",
                                    title="Source to find the rule in the net") }}
                        {% if form.version.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.version.errors[0] | safe }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mt-3">
                        <strong>{{ form.cve_id.label(class_="col-form-label") }}</strong>

                        <div class="input-group">
                            <select id="cve-type" class="form-select" style="max-width: 160px;">
                                <option value="CVE" selected>CVE</option>
                                <option value="GHSA">GHSA</option>
                                <option value="PYSEC">PYSEC</option>
                                <option value="GSD">GSD</option>
                                <option value="GCVE">GCVE</option>
                                <option value="CERTFR">CERTFR</option>
                                <option value="RHSA">RHSA</option>
                                <option value="CISCO-SA">Cisco</option>
                                <option value="MSRC_CVE">MSRC</option>
                            </select>

                            <input
                                type="text"
                                id="cve-id-input"
                                class="form-control"
                                placeholder="Enter vulnerability number (e.g., 2024-1234)"
                                autocomplete="off"
                            >

                            <button type="button" class="btn btn-dark" id="add-cve-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        {{ form.cve_id(class_="form-control d-none") }}

                        {% if form.cve_id.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.cve_id.errors[0] | safe }}
                            </div>
                        {% endif %}

                        <div id="cve-badge-container" class="d-flex flex-wrap gap-2 mb-2 p-3"></div>

                    </div>
                </div>
            </div>
            

            <div class="mb-3">
                <div class="form-group">
                    {{ form.description.label(class_="col-form-label") }}
                    {{ form.description(class_="form-control", rows=4,
                                    placeholder="Enter the description of the rule (context, explain...)...",
                                    title="Description for the context, the syntax... to help the community to found it") }}
                    {% if form.description.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.description.errors[0] | safe }}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <div class="form-group">
                        {{ form.original_uuid.label(class_="col-form-label") }}
                        {{ form.original_uuid(class_="form-control", rows=4,
                                    placeholder="Enter the original uuid if the rule has already one...",
                                    title="UUID to the rule. (one will be generate after the creation of the rule)") }}
                        {% if form.original_uuid.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.original_uuid.errors[0] | safe }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mb-3">
                {% if error %}
                        <div class="alert alert-danger d-flex align-items-center" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                {{ error }}
                            </div>
                        </div>
                        {% endif %}
                <div class="form-group">
                    {{ form.to_string.label(class_="col-form-label") }}
            
                    <input type="hidden" name="to_string" id="code-input" value="{{ form.to_string.data | e }}">  
            

                    <textarea id="editor">{{ form.to_string.data | e }}</textarea>
            
                    {% if form.to_string.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.to_string.errors[0] | safe }}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="text-center">
                {{ form.submit(class='btn btn-primary') }}
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block script %}


<script>
    /**
     * 
     *  #################
     *  #   CVE badge   #
     *  #################
     * 
     * */
    document.addEventListener("DOMContentLoaded", function () {
        const addBtn = document.getElementById("add-cve-btn");
        const input = document.getElementById("cve-id-input");
        const typeSelect = document.getElementById("cve-type");
        const container = document.getElementById("cve-badge-container");
        const hiddenInput = document.getElementById("cve_id");

        const colorMap = {
            "CVE": "badge bg-danger text-light",
            "GHSA": "badge bg-primary text-light",
            "PYSEC": "badge bg-warning text-dark",
            "GSD": "badge bg-success text-light",
            "GCVE": "badge bg-info text-dark",
            "CERTFR": "badge bg-secondary text-light",
            "RHSA": "badge bg-dark text-light",
            "CISCO-SA": "badge bg-light text-dark border border-dark",
            "MSRC_CVE": "badge bg-purple text-light"
        };

        const style = document.createElement('style');
        style.innerHTML = `.bg-purple { background-color: #6f42c1 !important; }`;
        document.head.appendChild(style);

        let cveList = [];

        function updateHiddenInput() {
            hiddenInput.value = cveList.join(",");
        }

        function createBadge(fullCVE) {
            const [type] = fullCVE.split('-');
            const badge = document.createElement("span");
            badge.className = (colorMap[type] || "badge bg-secondary text-light") + " d-flex align-items-center me-2 mb-2";
            badge.textContent = fullCVE;

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn-close btn-close-white ms-2";
            removeBtn.setAttribute("aria-label", "Remove");
            removeBtn.onclick = () => {
                badge.remove();
                const index = cveList.indexOf(fullCVE);
                if (index !== -1) cveList.splice(index, 1);
                updateHiddenInput();
            };

            badge.appendChild(removeBtn);
            container.appendChild(badge);
        }

        function addCVE() {
            const type = typeSelect.value.trim();
            const id = input.value.trim();
            if (!id) return false;

            const safeType = type.replace(/\s+/g, '');
            const safeId = id.replace(/\s+/g, '');
            const fullCVE = `${safeType}-${safeId}`;

            const validPattern = /^[A-Z0-9_\-]+-\d{4,}-\d+$/i;
            if (!validPattern.test(fullCVE) || cveList.includes(fullCVE)) {
                input.classList.add("is-invalid");
                return false;
            }

            input.classList.remove("is-invalid");
            cveList.push(fullCVE);
            createBadge(fullCVE);
            updateHiddenInput();
            input.value = "";
            return false;
        }

        addBtn.addEventListener("click", addCVE);
        input.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                addCVE();
            }
        });

        if (hiddenInput.value) {
            hiddenInput.value.split(",").forEach(cve => {
                if (cve.trim()) {
                    cveList.push(cve.trim());
                    createBadge(cve.trim());
                }
            });
        }
    });





    $(document).ready(function() {
    $('#license-select').select2({
        placeholder: "Search for a license",
        allowClear: true
    });

    const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        lineNumbers: true,
        mode: "yaml",  
        theme: "monokai",
        matchBrackets: true,
        autoRefresh: true
    });


    editor.on("change", function(cm) {
        document.getElementById("code-input").value = cm.getValue();
    });

    $("form").on("submit", function(event) {
        if ($("#code-input").val() === "") {
            event.preventDefault();
            alert("Please fill in the content for the rule.");
        }
    });
});
</script>
{% endblock %}
