{% extends 'base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
<div class="container mt-4 mb-5" id="main-container">
    <div class="mb-4 border-bottom pb-3">
        <h2 class="fw-bold mb-1 text-primary text-center">
            Edit [[ currentRule.title || 'Rule' ]]
            <div class="mx-auto" style="width: 60px; height: 4px; background-color: #0d6efd; border-radius: 2px;"></div>
        </h2>
        <p class="text-muted mt-2 text-center">
            Modify the details of your rule below. Ensure all required fields marked with an asterisk are completed.
        </p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-4">
                    <form action="" method="post" id="form">
                        {{ form.hidden_tag() }}

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold text-dark">
                                        {{ form.title.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.title(class_="form-control rounded-3", placeholder="Enter the rule
                                    title...") }}
                                    {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">{{ form.title.errors[0] | safe }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold text-dark">
                                        {{ form.format.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.format(class_="form-select rounded-3") }}
                                    {% if form.format.errors %}
                                    <div class="invalid-feedback d-block">{{ form.format.errors[0] | safe }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label fw-bold text-dark">{{ form.license.label.text }}</label>
                                    {{ form.license(class_="form-control rounded-3", id="license-select") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label fw-bold text-dark">{{ form.source.label.text }}</label>
                                    {{ form.source(class_="form-control rounded-3", placeholder="Source URL...") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <version-picker v-model="formData.version" label="Version">
                                </version-picker>
                                <input type="hidden" name="version" :value="formData.version">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12 text-start">
                                <tag-input v-model="selectedTags" label="Rule Tags" :user-id="{{current_user.id}}"
                                    placeholder="Search and add tags...">
                                </tag-input>
                                <input type="hidden" name="tags" :value="JSON.stringify(selectedTags)">
                            </div>
                        </div>

                        <div class="row mb-4 text-start">
                            <div class="col-12">
                                <vulnerability-input v-model="detectedVulnerabilities" target-type="rule"
                                    :target-id="ruleId" label="Vulnerabilities (CVE, GHSA...)">
                                </vulnerability-input>
                                <input type="hidden" name="vulnerabilities"
                                    :value="JSON.stringify(detectedVulnerabilities)">
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-12 text-start">
                                <div class="form-group">
                                    <label class="form-label fw-bold text-dark">{{ form.description.label.text
                                        }}</label>
                                    {{ form.description(class_="form-control rounded-3", rows=3, placeholder="Describe
                                    the purpose of this rule...") }}
                                </div>
                            </div>
                            <div class="col-md-12 text-start">
                                <div class="form-group">
                                    <label class="form-label fw-bold text-dark">{{ form.original_uuid.label.text
                                        }}</label>
                                    {{ form.original_uuid(class_="form-control rounded-3", placeholder="Optional:
                                    Existing UUID if any...") }}
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 text-start">
                            <div class="form-group">
                                <label class="form-label fw-bold text-dark">
                                    {{ form.to_string.label.text }} <span class="text-danger">*</span>
                                </label>
                                <div class="border rounded-3 overflow-hidden shadow-sm">
                                    <codemirror-editor v-model="currentRule.to_string" mode="yaml" height="500px">
                                    </codemirror-editor>
                                </div>
                                <input type="hidden" name="to_string" :value="currentRule.to_string">
                                {% if form.to_string.errors %}
                                <div class="invalid-feedback d-block fw-bold mt-2">{{ form.to_string.errors[0] | safe }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        {% if error %}
                        <div class="alert alert-danger rounded-3 d-flex align-items-center mb-4 border-0 shadow-sm">
                            <i class="fas fa-exclamation-triangle me-3 fa-lg"></i>
                            <div>{{ error }}</div>
                        </div>
                        {% endif %}

                        <div class="text-center pt-2">
                            {{ form.submit(class='btn btn-primary btn-lg rounded-pill px-5 shadow-sm') }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script type="module">
    const { createApp, ref, reactive, onMounted, watch } = Vue
    import { message_list, create_message } from '/static/js/toaster.js'
    import VulnerabilityInput from '/static/js/vulnerability/vulnerabilityInput.js';
    import CodeMirrorEditor from '/static/js/codeMirror/codeMirrorEditor.js';
    import TagInput from '/static/js/tags/tagInput.js';
    import VersionPicker from '/static/js/tags/utils/versionPicker.js';

    createApp({
        delimiters: ['[[', ']]'],
        components: {
            'vulnerability-input': VulnerabilityInput,
            'codemirror-editor': CodeMirrorEditor,
            'tag-input': TagInput,
            'version-picker': VersionPicker
        },
        setup() {

            const ruleId = ref("{{ rule.id | safe }}");
            const currentRule = ref({ title: '', to_string: '' });


            const detectedVulnerabilities = ref([]);
            const selectedTags = ref([]);

            const formData = reactive({
                version: "{{ form.version.data or '1.0' }}",
            });


            async function initRuleTags() {
                try {
                    const res = await fetch(`/rule/get_rule_tags_display/${ruleId.value}`);
                    const data = await res.json();
                    if (data.success) {
                        selectedTags.value = data.tags;
                    }
                } catch (error) {
                    console.error("Initialization error tags:", error);
                }
            }


            async function fetchCurrentRule() {
                try {
                    const response = await fetch('/rule/get_current_rule?rule_id=' + ruleId.value);
                    if (response.ok) {
                        const data = await response.json();
                        currentRule.value = data.rule;
                        if (data.rule.to_string) {
                            currentRule.value.to_string = data.rule.to_string;
                        }
                    }
                } catch (e) {
                    console.error("Error fetching rule info:", e);
                }
            }

            onMounted(async () => {

                await Promise.all([
                    fetchCurrentRule(),
                    initRuleTags()
                ]);


                if (window.$ && $.fn.select2) {
                    $('#license-select').select2({
                        placeholder: "Search for a license",
                        allowClear: true,
                        width: '100%'
                    });
                }
            });

            return {
                message_list,
                create_message,
                detectedVulnerabilities,
                ruleId,
                currentRule,
                selectedTags,
                formData,
                VersionPicker,
                TagInput,
                CodeMirrorEditor,
                VulnerabilityInput
            }
        },
    }).mount('#main-container');
</script>
{% endblock %}