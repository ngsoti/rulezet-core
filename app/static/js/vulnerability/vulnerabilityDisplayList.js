/**
 * vulnerabilitiesDisplayList Component
 * Gère de manière autonome la récupération et l'affichage des vulnérabilités cliquables.
 */
const vulnerabilitiesDisplayList = {
    props: {
        objectId: { type: [Number, String], required: true },
        objectType: { type: String, required: true, validator: v => ['bundle', 'rule'].includes(v) },
        maxVisible: { type: Number, default: 5 },
        sectionTitle: { type: String, default: '' },
    },
    delimiters: ['[[', ']]'],
    setup(props) {
        const vulnerabilities = Vue.ref([]);
        const loading = Vue.ref(false);

        const fetchVulnerabilities = async () => {
            if (!props.objectId) return;
            loading.value = true;
            try {
                const response = await fetch(`/bundle/get_bundle_vulnerabilities_display/${props.objectId}`);
                if (response.ok) {
                    const data = await response.json();
                    vulnerabilities.value = data.vulnerabilities || [];
                }
            } catch (e) {
                console.error("Error fetching vulnerabilities:", e);
            } finally {
                loading.value = false;
            }
        };

        const getCVEPrefix = (item) => item ? item.split("-")[0].toUpperCase() : "";
        const getCVENumber = (item) => item ? item.replace(/^[A-Za-z_:-]+/, "").replace(/^-/, "") : "";
        
        const getCVEColor = (item) => {
            if (item.startsWith("CVE")) return "bg-danger";
            if (item.startsWith("GHSA")) return "bg-warning text-dark";
            if (item.startsWith("PYSEC")) return "bg-info text-dark";
            if (item.startsWith("RHSA")) return "bg-danger";
            return "bg-dark text-white";
        };

        const getCVEIcon = (item) => {
            if (item.startsWith("CVE")) return "fas fa-shield-alt";
            if (item.startsWith("GHSA")) return "fas fa-bug";
            if (item.startsWith("PYSEC")) return "fas fa-code";
            return "fas fa-exclamation-triangle";
        };

        const getVulnUrl = (item) => {
            const val = item.toUpperCase();
            if (val.startsWith("CVE")) return `https://vulnerability.circl.lu/vuln/${item.toLowerCase()}`;
            if (val.startsWith("GHSA")) return `https://github.com/advisories?query=${item}`;
            if (val.startsWith("PYSEC")) return `https://osv.dev/vulnerability/${item}`;
            return `https://www.google.com/search?q=${item}`;
        };

        Vue.onMounted(fetchVulnerabilities);
        Vue.watch(() => props.objectId, fetchVulnerabilities);

        return { 
            vulnerabilities, loading, 
            getCVEPrefix, getCVENumber, getCVEColor, getCVEIcon, getVulnUrl 
        };
    },
    data() {
        return { isShowingAll: false };
    },
    template: `
    <div class="vulnerability-display-container">
        <div v-if="sectionTitle" class="d-flex align-items-center mb-2 mt-1">
            <div class="bg-danger rounded-pill me-2" style="width: 3px; height: 14px;"></div>
            <span class="text-uppercase fw-bold text-muted" style="font-size: 0.65rem; letter-spacing: 0.05rem;">
                [[ sectionTitle ]]
            </span>
        </div>

        <div v-if="loading" class="d-flex gap-1 py-1">
            <div class="spinner-grow spinner-grow-sm text-danger opacity-25" role="status"></div>
            <div class="spinner-grow spinner-grow-sm text-danger opacity-25" role="status" style="animation-delay: 0.1s"></div>
        </div>

        <div v-else class="d-flex flex-wrap gap-2 align-items-center">
            <a v-for="item in visibleVulns" 
               :key="item" 
               :href="getVulnUrl(item)" 
               target="_blank"
               class="d-flex align-items-center rounded-2 shadow-sm animate__animated animate__fadeIn text-decoration-none on-hover-lift" 
               :class="getCVEColor(item)" 
               style="font-size: 0.75rem; font-family: monospace; overflow: hidden; min-height: 26px; transition: transform 0.2s;">
                
                <div class="px-2 py-1 bg-black bg-opacity-10 text-white border-end border-white border-opacity-10 h-100 d-flex align-items-center">
                    <i :class="getCVEIcon(item)" style="font-size: 0.7rem;"></i>
                </div>
                
                <div class="px-2 py-1 fw-bold text-white">
                    <span class="opacity-75">[[ getCVEPrefix(item) ]]</span>-[[ getCVENumber(item) ]]
                </div>
            </a>

            <button v-if="vulnerabilities.length > maxVisible" 
                @click.stop="isShowingAll = !isShowingAll" 
                class="btn btn-sm border rounded-pill bg-white text-danger fw-bold shadow-sm transition-all"
                style="font-size: 0.7rem; padding: 2px 10px; height: 26px;">
                [[ isShowingAll ? 'Collapse' : '+' + (vulnerabilities.length - maxVisible) ]]
            </button>

            
        </div>
    </div>
    `,
    computed: {
        visibleVulns() {
            return this.isShowingAll ? this.vulnerabilities : this.vulnerabilities.slice(0, this.maxVisible);
        }
    }
};

export default vulnerabilitiesDisplayList;