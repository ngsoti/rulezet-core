const MultiVulnerabilityFilter = {
    props: {
        modelValue: { type: Array, default: () => [] },
        placeholder: { type: String, default: 'Filter by vulnerabilities...' },
        apiEndpoint: { type: String, default: '/bundle/get_all_vulnerabilities_usage' },
        userId: { type: Number, default: null },
        sourceRules: { type: String, default: '' }
    },
    emits: ['update:modelValue', 'change'],
    delimiters: ['[[', ']]'],
    setup(props, { emit }) {
        const list_vulns = Vue.ref([]); 
        const searchCtx = Vue.ref('');
        const selectedNames = Vue.ref([...props.modelValue]);
        const activePrefix = Vue.ref(null);

        Vue.watch(() => props.modelValue, (newVal) => {
            selectedNames.value = [...newVal];
        }, { deep: true });

        const fetchVulns = async () => {
            try {
                let url = props.apiEndpoint;
                const params = new URLSearchParams();
                
                if (props.userId !== null && !isNaN(props.userId)) {
                    params.append('user_id', props.userId.toString());
                }

               
                if (props.sourceRules) {
                    params.append('sources', props.sourceRules);
                }

                const queryString = params.toString();
                if (queryString) {
                    url += (url.includes('?') ? '&' : '?') + queryString;
                }

                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    list_vulns.value = data.vulnerabilities || [];
                }
            } catch (e) { 
                console.error("Error loading filter vulnerabilities", e); 
            }
        };
        const groupedVulns = Vue.computed(() => {
            const groups = {};
            list_vulns.value.forEach(v => {
                const parts = v.name.split('-');
                const prefix = parts.length > 1 ? parts[0].toUpperCase() : 'OTHER';
                if (!groups[prefix]) groups[prefix] = [];
                groups[prefix].push(v);
            });
            return groups;
        });

        const filteredList = Vue.computed(() => {
            if (!searchCtx.value) return null;
            const q = searchCtx.value.toLowerCase();
            return list_vulns.value.filter(v => v.name.toLowerCase().includes(q));
        });

        const toggleVuln = (name) => {
            const index = selectedNames.value.indexOf(name);
            if (index > -1) {
                selectedNames.value.splice(index, 1);
            } else {
                selectedNames.value.push(name);
            }
            emit('update:modelValue', [...selectedNames.value]);
            emit('change', [...selectedNames.value]);
        };

        const getVulnColor = (name) => {
            const n = name.toUpperCase();
            if (n.startsWith("CVE")) return "bg-danger";
            if (n.startsWith("GHSA")) return "bg-warning text-dark";
            if (n.startsWith("PYSEC")) return "bg-info text-dark";
            if (n.startsWith("RHSA")) return "bg-danger";
            return "bg-dark text-white";
        };

        const getVulnIcon = (name) => {
            const n = name.toUpperCase();
            if (n.startsWith("CVE")) return "fas fa-shield-alt";
            if (n.startsWith("GHSA")) return "fas fa-bug";
            if (n.startsWith("PYSEC")) return "fas fa-code";
            return "fas fa-exclamation-triangle";
        };

        Vue.onMounted(fetchVulns);

        return {
            searchCtx, groupedVulns, selectedNames, activePrefix,
            toggleVuln, filteredList, getVulnColor, getVulnIcon,
            clearAll: () => { 
                selectedNames.value = []; 
                emit('update:modelValue', []); 
                emit('change', []);
            }
        };
    },
template: `
    <div class="dropdown multi-vuln-filter w-100">
        <div class="form-control d-flex flex-wrap gap-2 align-items-center p-2 shadow-sm border-secondary-subtle" 
             data-bs-toggle="dropdown" data-bs-auto-close="outside" 
             style="cursor: pointer; min-height: 48px; border-radius: 12px;">
            
            <i class="fa-solid fa-shield-virus text-danger opacity-75 ms-1 me-1"></i>
            <span v-if="selectedNames.length === 0" class="text-muted small fw-bold">[[ placeholder ]]</span>

            <span v-for="name in selectedNames" :key="name" 
                  class="d-flex align-items-center rounded-2 shadow-sm animate__animated animate__fadeInSmall" 
                  :class="getVulnColor(name)" style="font-size: 0.75rem; font-family: monospace; overflow: hidden;">
                <div class="px-2 py-1 bg-black bg-opacity-10 border-end border-white border-opacity-10">
                    <i :class="getVulnIcon(name)"></i>
                </div>
                <div class="px-2 py-1 d-flex align-items-center text-white">
                    <span class="fw-bold me-2">[[ name ]]</span>
                    <i class="fa-solid fa-circle-xmark opacity-75 ms-1 hover-scale" @click.stop="toggleVuln(name)" style="cursor: pointer;"></i>
                </div>
            </span>
            <i class="fa-solid fa-chevron-down ms-auto me-1 text-muted small"></i>
        </div>

        <div class="dropdown-menu shadow-lg border-0 w-100 p-3 mt-2 animate__animated animate__fadeIn" 
             style="max-height: 550px; border-radius: 15px; z-index: 1060; min-width: 350px;">
            
            <div class="d-flex align-items-center mb-3">
                <button v-if="activePrefix && !searchCtx" @click="activePrefix = null" 
                        class="btn btn-sm btn-outline-danger border-0 me-2 rounded-circle d-flex align-items-center justify-content-center"
                        style="width: 30px; height: 30px;">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light border-0"><i class="fa-solid fa-magnifying-glass"></i></span>
                    <input type="text" v-model="searchCtx" class="form-control bg-light border-0 shadow-none" placeholder="Search (ex: CVE-2024)...">
                </div>
            </div>

            <div class="custom-tag-scroll pe-2" style="max-height: 400px; overflow-y: auto;">
                
                <div v-if="searchCtx" class="d-flex flex-column gap-1">
                    <div v-for="v in filteredList" :key="v.name" 
                         @click="toggleVuln(v.name)" 
                         class="p-2 rounded border d-flex align-items-center justify-content-between tag-item-hover "
                         :class="{'border-danger bg-danger-subtle shadow-sm': selectedNames.includes(v.name)}"
                         style="cursor:pointer;">
                         <div class="d-flex align-items-center">
                            <i :class="[getVulnIcon(v.name), 'me-2 ']" style="font-size: 0.8rem; color: var(--text-color);"></i>
                            <span class="small fw-bold" style="font-family: monospace; color: var(--text-color);">[[ v.name ]]</span>
                         </div>
                         <span class="badge rounded-pill bg-light border" style="color: var(--text-color);">[[ v.usage_count ]]</span>
                    </div>
                    <div v-if="filteredList.length === 0" class="text-center py-4">
                        <i class="fa-solid fa-magnifying-glass mb-2 opacity-50" style="font-size: 1.2rem; color: var(--text-color);"></i>
                        <p class=" small fw-bold mb-0" style="color: var(--text-color);">No vulnerability matches your search.</p>
                    </div>
                </div>

                <div v-else-if="!activePrefix" class="d-flex flex-column gap-2">
                    <div v-for="(items, prefix) in groupedVulns" :key="prefix" 
                         @click="activePrefix = prefix"
                         class="p-2 px-3 rounded-3 border d-flex align-items-center justify-content-between tag-item-hover shadow-xs" 
                         style="cursor: pointer; min-height: 50px;">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger bg-opacity-10 p-2 rounded-circle me-3">
                                <i class="fa-solid fa-shield-halved text-danger"></i>
                            </div>
                            <span class="fw-bold" style="color: var(--text-color)">[[ prefix ]]</span>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="extra-small fw-bold" style="color: var(--text-color)">[[ items.length ]] identifiers</span>
                            <i class="fa-solid fa-chevron-right opacity-50 small" style="color: var(--text-color);"></i>
                        </div>
                    </div>
                    <div v-if="Object.keys(groupedVulns).length === 0" class="text-center py-5">
                       
                        <p class=" small fw-bold mb-0" style="color: var(--text-color);">No vulnerabilities used or found...</p>
                    </div>
                </div>

                <div v-else class="animate__animated animate__fadeInUpSmall">
                    <div class="px-2 mb-2 d-flex justify-content-between align-items-center border-bottom pb-2">
                        <small class="fw-black text-danger text-uppercase">[[ activePrefix ]] Registry</small>
                        <small class=" small" style="color: var(--text-color)">[[ groupedVulns[activePrefix].length ]] advisories</small>
                    </div>
                    
                    <div class="d-flex flex-column gap-2 mt-2">
                        <div v-for="v in groupedVulns[activePrefix]" :key="v.name" 
                             @click="toggleVuln(v.name)" 
                             class="p-2 rounded-3 border d-flex align-items-center justify-content-between transition-all tag-item-hover "
                             :class="selectedNames.includes(v.name) ? 'border-danger bg-danger-subtle' : ''"
                             style="cursor:pointer;">
                            
                            <div class="d-flex align-items-center overflow-hidden">
                                <div class="d-flex align-items-center rounded-2 overflow-hidden" :class="getVulnColor(v.name)" style="font-size: 0.75rem; font-family: monospace;">
                                    <div class="px-2 py-1 bg-black bg-opacity-10 text-white border-end border-white border-opacity-10 h-100">
                                        <i :class="getVulnIcon(v.name)"></i>
                                    </div>
                                    <div class="px-2 py-1 fw-bold text-white">[[ v.name ]]</div>
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge rounded-pill border" style="font-size: 0.65rem; color: var(--text-color);">[[ v.usage_count ]]</span>
                                <i v-if="selectedNames.includes(v.name)" class="fa-solid fa-check-circle text-danger scale-in"></i>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    `
};

export default MultiVulnerabilityFilter;