const VulnerabilityDisplay = {
    props: {
        vulnerabilities: { type: Array, default: () => [] },
        loading: { type: Boolean, default: false },
        maxVisible: { type: Number, default: 10 },
        sectionTitle: { type: String, default: 'Vulnerability Identifiers' }
    },
    delimiters: ['[[', ']]'],
    data() {
        return { 
            isCollapsed: false, 
            isShowingAll: false 
        };
    },
   template: `
    <div class="mt-4 mb-4" v-if="vulnerabilities">
        <div @click="isCollapsed = !isCollapsed" style="cursor: pointer;" class="user-select-none">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="fw-bold mb-0 text-dark d-flex align-items-center">
                    <span class="text-primary me-2">|</span>[[ sectionTitle ]]
                    <i class="fas fa-chevron-down ms-2 small opacity-50 transition-all"
                        :style="{ transform: isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)', transition: '0.3s' }"></i>
                </h4>
                <span v-if="!isCollapsed" class="badge bg-light text-primary border rounded-pill px-3 shadow-sm">
                    [[ (vulnerabilities || []).length ]] items
                </span>
            </div>
            
            <div v-if="isCollapsed" class="text-muted small mt-1" style="padding-left: 1.5rem;">
                <i class="fas fa-info-circle me-1"></i> Summary: <strong>[[ (vulnerabilities || []).length ]] identifiers</strong> hidden. Click to expand.
            </div>
        </div>

        <div v-show="!isCollapsed" class="mt-3 animate__animated animate__fadeIn">
            <div class="d-flex flex-wrap gap-2 p-3 bg-light rounded-3 shadow-sm border border-dashed">
                
                <a v-for="item in visibleVulns" 
                   :key="item" 
                   :href="getVulnUrl(item)" 
                   target="_blank"
                   class="d-flex align-items-center rounded-2 shadow-sm animate__animated animate__fadeIn text-decoration-none on-hover-lift" 
                   :class="getCVEColor(item)" 
                   style="font-size: 0.85rem; font-family: monospace; overflow: hidden; min-height: 32px; transition: transform 0.2s;">
                    
                    <div class="px-2 py-1 bg-black bg-opacity-10 text-white border-end border-white border-opacity-10 h-100 d-flex align-items-center">
                        <i :class="getCVEIcon(item)"></i>
                    </div>
                    
                    <div class="px-2 py-1 fw-bold text-white">
                        <span class="opacity-75">[[ getCVEPrefix(item) ]]</span>-[[ getCVENumber(item) ]]
                        <i class="fas fa-external-link-alt ms-1 small opacity-50" style="font-size: 0.6rem;"></i>
                    </div>
                </a>

                <button v-if="vulnerabilities.length > maxVisible" 
                        @click.stop="isShowingAll = !isShowingAll" 
                        class="btn btn-sm btn-outline-secondary rounded-pill px-3 fw-bold shadow-sm transition-all bg-white"
                        style="font-size: 0.75rem;">
                    [[ isShowingAll ? 'Show Less' : '+ ' + (vulnerabilities.length - maxVisible) + ' more' ]]
                </button>

                <div v-if="vulnerabilities.length === 0 && !loading" class="text-muted small fst-italic py-1">
                    <i class="fas fa-shield-alt me-1 opacity-50"></i> No vulnerabilities identified.
                </div>
                
                <div v-if="loading" class="d-flex align-items-center gap-2 py-1">
                    <div class="spinner-border spinner-border-sm text-danger"></div>
                    <small class="text-muted">Loading identifiers...</small>
                </div>
            </div>
        </div>
    </div>
    `,
    computed: {
        visibleVulns() {
            if (!this.vulnerabilities) return [];
            return this.isShowingAll ? this.vulnerabilities : this.vulnerabilities.slice(0, this.maxVisible);
        }
    },
    methods: {
        getVulnUrl(item) {
            const val = item.toUpperCase();

            if (val.startsWith("CVE")) return `https://vulnerability.circl.lu/vuln/${item.toLowerCase()}`;
            if (val.startsWith("GHSA")) return `https://github.com/advisories?query=${item}`;
            if (val.startsWith("PYSEC")) return `https://osv.dev/vulnerability/${item}`;
            if (val.startsWith("RHSA")) return `https://access.redhat.com/errata/${item}`;
            
            return `https://www.google.com/search?q=${item}`;
        },
        getCVEPrefix(item) {
            return item ? item.split("-")[0].toUpperCase() : "";
        },
        getCVENumber(item) {
            return item ? item.replace(/^[A-Za-z_:-]+/, "").replace(/^-/, "") : "";
        },
        getCVEColor(item) {
            if (item.startsWith("CVE")) return "bg-danger";
            if (item.startsWith("GHSA")) return "bg-warning";
            if (item.startsWith("PYSEC")) return "bg-info text-dark";
            if (item.startsWith("GSD")) return "bg-secondary";
            if (item.startsWith("GCVE")) return "bg-primary";
            if (item.startsWith("RHSA")) return "bg-danger";
            return "bg-dark text-white";
        },
        getCVEIcon(item) {
            if (item.startsWith("CVE")) return "fas fa-shield-alt";
            if (item.startsWith("GHSA")) return "fas fa-bug";
            if (item.startsWith("PYSEC")) return "fas fa-code";
            if (item.startsWith("RHSA")) return "fas fa-lock";
            return "fas fa-exclamation-triangle";
        }
    }
};

export default VulnerabilityDisplay;